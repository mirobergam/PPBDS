<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta property="og:title" content="Chapter 4 Functions | We R Who We R: Preceptor’s Primer for Bayesian Data Science" />
<meta property="og:type" content="book" />



<meta name="github-repo" content="davidkane9/PPBDS" />

<meta name="author" content="David Kane" />

<meta name="date" content="2020-07-27" />

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: { equationNumbers: { autoNumber: "AMS" } }
});
</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS_CHTML-full" type="text/javascript"></script>

<meta name="description" content="Chapter 4 Functions | We R Who We R: Preceptor’s Primer for Bayesian Data Science">

<title>Chapter 4 Functions | We R Who We R: Preceptor’s Primer for Bayesian Data Science</title>

<link href="libs/tufte-css-2015.12.29/tufte.css" rel="stylesheet" />
<link href="libs/tufte-css-2015.12.29/envisioned.css" rel="stylesheet" />
<link href="libs/msmb-css-0/msmb.css" rel="stylesheet" />
<script>
function toggle_visibility(id1, id2) {
var e = document.getElementById(id1);
var f = document.getElementById(id2);

e.style.display = ((e.style.display!='none') ? 'none' : 'block');

if(f.classList.contains('fa-plus-square')) {
    f.classList.add('fa-minus-square')
    f.classList.remove('fa-plus-square')
} else {
    f.classList.add('fa-plus-square')
    f.classList.remove('fa-minus-square')
}

}
</script>
<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>
<script src="libs/htmlwidgets-1.5.1/htmlwidgets.js"></script>
<link href="libs/str_view-0.1.0/str_view.css" rel="stylesheet" />
<script src="libs/str_view-binding-1.4.0/str_view.js"></script>
<script src="libs/kePrint-0.0.1/kePrint.js"></script>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }

code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />

</head>

<body>



<div class="row">
<div class="col-sm-12">
<div id="TOC">
<ul class="navbar">
<li class="msmb"><p class="title">We R Who We R: Preceptor's Primer for Bayesian Data Science<p><p class="author">David Kane</p>
<li class="dropdown" style="float:right">
<a href="javascript:void(0)" class="dropbtn">&#x25BE; Chapters</a>
<div class="dropdown-content">
<a href="index.html">Cover</a>
<a href="preamble.html">Preamble</a>
<a href="shopping-week.html">Shopping Week</a>
<a href="visualization.html"><span class="toc-section-number">1</span> Visualization</a>
<a href="tidyverse.html"><span class="toc-section-number">2</span> Tidyverse</a>
<a href="rubin-causal-model.html"><span class="toc-section-number">3</span> Rubin Causal Model</a>
<a id="active-page" href="functions.html"><span class="toc-section-number">4</span> Functions</a><ul class="toc-sections">
<li class="toc"><a href="#introduction-to-functions"> Introduction to Functions</a></li>
<li class="toc"><a href="#NA"> List-columns and <code>map_*</code> functions</a></li>
<li class="toc"><a href="#built-in-functions-and-custom-functions"> Built-In Functions and Custom Functions</a></li>
<li class="toc"><a href="#argument-specifications-and-a-data-generating-mechanism"> Argument Specifications and a Data Generating Mechanism</a></li>
<li class="toc"><a href="#formal-testing"> Formal Testing</a></li>
<li class="toc"><a href="#NA"> List-columns and <code>map_*</code> functions with custom and anonymous functions</a></li>
</ul>
<a href="probability.html"><span class="toc-section-number">5</span> Probability</a>
<a href="sampling.html"><span class="toc-section-number">6</span> Sampling</a>
<a href="one-parameter.html"><span class="toc-section-number">7</span> One Parameter</a>
<a href="two-parameters.html"><span class="toc-section-number">8</span> Two Parameters</a>
<a href="n-parameters.html"><span class="toc-section-number">9</span> N Parameters</a>
<a href="continuous-response.html"><span class="toc-section-number">10</span> Continuous Response</a>
<a href="appendices.html">Appendices</a>
<a href="tools.html">Tools</a>
<a href="shiny.html">Shiny</a>
<a href="maps.html">Maps</a>
<a href="animation.html">Animation</a>
<a href="references-1.html">References</a>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="row">
<div class="col-sm-12">
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html><body><div id="functions" class="section level1">
<h1>
<span class="header-section-number">Chapter 4</span> Functions</h1>
<!-- 1. Functions are cool. Not teaching you to write one yet though! An especially cool type of function is map function. Play with map functions. Oh! What happens when a map function causes a list column to appear. Oh no! -->
<!-- 2. Reminder about lists. How we work with lists. And how we work with list columns. -->
<!-- 3) But we are sadly limited! We can only use built in functions! Sad! What happens when we want to . . . Answer write our own functions. Focus on functions which work with random numbers. Functions which work with lists. Functions which can return a vector whose length depends on a size argument. -->
<!-- Recall that dgm <- function(size, obj, new_data){} -->
<!-- No `with()` -->
<!-- Start with functions are cool. Remind them about lists. Show some simple functions that take a list. add_one_and_one <- function(){ -->
<!--   1 +1 -->
<!-- } -->
<!-- add_six_to_something <- function(x){ -->
<!--   x + 6 -->
<!-- } -->
<!-- add_x_to_y <- function(x, y){ -->
<!--   x + y -->
<!-- } -->
<!-- Some functions which take a list as an argument. Occasion to remind the reader what lists are and how to deal with them. -->
<!-- first_in_list <- function(x){ -->
<!-- } -->
<!-- add_list <- function(x){ -->
<!-- } -->
<!-- Introduce map functions first. -->
<!-- 0. Add 30 list-column and mapping questions, generally with each set of questions grouped into a mini two or three question series. -->
<!-- 1. Make clear the mapping from chapter sections to tutorial panels. Fix the easily fixable from style.Rmd. -->
<!-- 2. Along the way, there are some key functions we want to teach students and this is as good a place as any to do it. Relevant posts (no need to read) include: -->
<!-- https://aosmith.rbind.io/2018/08/29/getting-started-simulating-data/ -->
<!-- https://aosmith.rbind.io/2018/06/05/a-closer-look-at-replicate-and-purrr/ -->
<!-- We need to explain how to use `runif()` and `rnorm()`, providing the actual formula for the normal distribution in the side margin, or perhaps just copying all the text/code from [ModernDive](https://moderndive.com/A-appendixA.html#appendix-normal-curve). We also need to teach them about `replicate()`. Neither of these truly fit here, but they don't fit anywhere else either. So, use these functions for as many of your examples as possible.  -->
<!-- Our function: myfunc <- function(){runif() + rnorm()}. First attempt to teach them a data generating mechanism. -->
<!-- Example: -->
<!-- tibble(id = 1:3) %>%  -->
<!--   mutate(draws = map(id, ~ rnorm(5))) %>% -->
<!--   mutate(big_minus_little = map_dbl(draws, ~ max(.) - min(.))) -->
<!-- Make sure to highlight how you need the map() to do the draws, otherwise you get the same five random numbers in each row. -->
<!-- That is not the fanciest thing, but many/most our examples, in the chapter and the tutorial, should make use of rnorm() and runif(). Besides being useful in themselves, we want to get students used to the idea of using simulations to answer questions. If I draw five standard normal numbers, what is the most likely value of the biggest of the 5 minus the smaller? -->
<!-- 3. Read the probability chapter in bok. Change the current example of a function which works with gapminder data to something else, maybe involving stuff from dice, coins and so on, setting the stage for chapter 5. The real key is that we want students to be very comfortable when we ask them to start constructing data generating mechanisms in chapters 7+. How do we set them up for success in that? By constructing some easy DGMs here! And some hard ones. Indeed, we could go from some simple to hard, discussing the trade-offs along the way. In this course, they won't ever (?) write a function which takes a tibble as an input. Or maybe they will --- if the results of some statistical procedure or simulation is in the form of a tibble. -->
<!-- 4. Some thoughts on DGMs in general. First, should they be designed to produce one result, and then be called with replicate to run again and again? Or should they take N as the first argument, so that they behave similarly to rnorm()? Second, what other arguments should they take? Simplest approach might be that they take none, that all the things needed are built into the function itself. Better (?) would be to, at least, pass in a new_data type argument, since that is so standard in functions like `posterior_predict()`. How are these issues handled in **tidymodels**? -->
<!-- 5. No scoping rules. -->
<p>The goal of this chapter is to reveal the <strong>process</strong> a long-time useR employs for writing functions. We also want to illustrate why the process is the way it is. Merely looking at the finished product, e.g. source code for R packages, can be extremely deceiving. Reality is generally much uglier … but more interesting! Powerful packages like <strong>dplyr</strong> and <strong>purrr</strong> are ready and waiting to apply your purpose-built functions to various bits of your data. If you can express your analytic wishes in a function, these tools will give you great power.</p>
<div id="introduction-to-functions" class="section level2">
<h2>
<span class="header-section-number">4.1</span> Introduction to Functions</h2>
<p>First, let’s introduce the concept of functions. A function is a piece of code that is packaged in a way that makes it easy to reuse. Functions make it easy for you to <code>filter()</code>, <code>sort()</code>, <code>select()</code>, and create a <code>data.frame()</code>, as you have seen in the last few chapters. Functions also allow you to transform variables and perform a bunch of useful mathematical calculations, such as finding the <code>min()</code>, <code>max()</code>, and <code>quantile()</code>s of a dataset. Functions are also important in generating data and values, such as using <code>rnorm()</code> to randomly generate a normal distribution.</p>
<p>Note that every time we mention a function, we include the parentheses. This is because you call a function by including its parentheses and any necessary arguments in those parentheses. If you run the function name without its parentheses, R will return the code that makes up the function.</p>
<div class="sourceCode" id="cb440"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb440-1"><a href="functions.html#cb440-1"></a>Sys.Date</span></code></pre></div>
<pre><code>## function () 
## as.Date(as.POSIXlt(Sys.time()))
## &lt;bytecode: 0x7fa92c6b1438&gt;
## &lt;environment: namespace:base&gt;</code></pre>
<div class="sourceCode" id="cb442"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb442-1"><a href="functions.html#cb442-1"></a><span class="kw">Sys.Date</span>()</span></code></pre></div>
<pre><code>## [1] "2020-07-27"</code></pre>
<p>There are plenty of built-in functions in R, such as the ones mentioned above. You can also create your own custom functions, which may look something like this:</p>
<div class="sourceCode" id="cb444"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb444-1"><a href="functions.html#cb444-1"></a>my_function &lt;-<span class="st"> </span><span class="cf">function</span>(x) x <span class="op">+</span><span class="st"> </span><span class="dv">1</span></span></code></pre></div>
<p>This code creates a function named <code>my_function()</code> that takes in in a value <code>x</code> and return a value <code>x + 1</code>. Alternatively, you could leave the function unnamed, as such:</p>
<div class="sourceCode" id="cb445"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb445-1"><a href="functions.html#cb445-1"></a><span class="cf">function</span>(x) x <span class="op">+</span><span class="st"> </span><span class="dv">1</span></span></code></pre></div>
<p>These nameless functions are called <a href="https://coolbutuseless.github.io/2019/03/13/anonymous-functions-in-r-part-1/">anonymous functions.</a> We can create functions that do operations “on the fly” without bothering to give them a name.</p>
<p>Functions can do all sorts of things. Below, <code>sample()</code> takes a vector of values and spits out a number of random values from that vector. You can specify the number of random values with the argument <code>size</code>. Let’s take it for a spin. This is the equivalent of rolling a die!</p>
<div class="sourceCode" id="cb446"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb446-1"><a href="functions.html#cb446-1"></a><span class="kw">sample</span>(<span class="dt">x =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">6</span>, <span class="dt">size =</span> <span class="dv">1</span>)</span></code></pre></div>
<pre><code>## [1] 6</code></pre>
<p>Functions can also take in other functions as arguments. For example, <code>replicate()</code> takes an expression and repeats it for <code>n</code> specified times. This is really useful when you want to generate many iterations of data. What if we replicated the rolling of a die ten times?</p>
<div class="sourceCode" id="cb448"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb448-1"><a href="functions.html#cb448-1"></a><span class="kw">replicate</span>(<span class="dv">10</span>, <span class="kw">sample</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">6</span>, <span class="dv">1</span>))</span></code></pre></div>
<pre><code>##  [1] 2 5 5 5 5 4 3 4 2 5</code></pre>
<p>We will dive into functions more in depth soon, but next we will discuss of list-columns and <code>map_*</code> functions.</p>
</div>
<div id="list-columns-and-map_-functions" class="section level2">
<h2>
<span class="header-section-number">4.2</span> List-columns and <code>map_*</code> functions</h2>
<p>We are now going to learn about <a href="https://r4ds.had.co.nz/many-models.html#list-columns-1"><strong>list columns</strong></a> and <a href="https://jennybc.github.io/purrr-tutorial/ls01_map-name-position-shortcuts.html"><strong><code>map_*</code> functions</strong></a>, powerful tools that we will be using throughout the book.<label for="tufte-sn-14" class="margin-toggle sidenote-number">14</label><input type="checkbox" id="tufte-sn-14" class="margin-toggle"><span class="sidenote"><span class="sidenote-number">14</span> If I were going to give a lecture on these topics, it would look like <a href="https://resources.rstudio.com/webinars/how-to-work-with-list-columns-garrett-grolemund">this one</a>.</span></p>
<div id="what-are-list-columns" class="section level3">
<h3>
<span class="header-section-number">4.2.1</span> What are list columns?</h3>
<p>Recall our previous discussion on lists.</p>
<p>Now that we understand what a list is, what is a list-column? A list column is a column of your data which is a <a href="https://adv-r.hadley.nz/vectors-chap.html#lists">list</a> rather than an atomic vector. Atomic vectors are familiar to us: each element of the vector has one value, and thus if an atomic vector is a column in your dataset, each observation gets a single value. Lists, however, can contain vectors as elements. The best way to understand this is by creating a list column yourself and inspecting the results. <code>str()</code> is a helpful function for looking at the contents of a tibble with list columns:</p>
<div class="sourceCode" id="cb450"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb450-1"><a href="functions.html#cb450-1"></a><span class="kw">library</span>(tidyverse)</span>
<span id="cb450-2"><a href="functions.html#cb450-2"></a></span>
<span id="cb450-3"><a href="functions.html#cb450-3"></a><span class="kw">tibble</span>(<span class="dt">new_col =</span> <span class="kw">list</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="dv">3</span><span class="op">:</span><span class="dv">5</span>)) <span class="op">%&gt;%</span></span>
<span id="cb450-4"><a href="functions.html#cb450-4"></a><span class="st">  </span><span class="kw">str</span>()</span></code></pre></div>
<pre><code>## tibble [2 × 1] (S3: tbl_df/tbl/data.frame)
##  $ new_col:List of 2
##   ..$ : int [1:2] 1 2
##   ..$ : int [1:3] 3 4 5</code></pre>
<p>Here we see that our tibble has one column (<code>new_col</code>) and one observation, which is a list with two elements. The first element in the list is a vector of the integers 1 and 2 and the second element is a vector of the integers 3, 4, and 5. The tibble only has one row because there is only one value for <code>new_col</code>.</p>
<p>Note that this is a case where it is crucial to use <code>tibble()</code>, not <code>data.frame()</code>! If we had used <code>data.frame()</code> in the last example, it wouldn’t have worked:</p>
<div class="sourceCode" id="cb452"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb452-1"><a href="functions.html#cb452-1"></a><span class="kw">data.frame</span>(<span class="dt">new_col =</span> <span class="kw">list</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="dv">3</span><span class="op">:</span><span class="dv">5</span>)) <span class="op">%&gt;%</span></span>
<span id="cb452-2"><a href="functions.html#cb452-2"></a><span class="st">  </span><span class="kw">str</span>()</span></code></pre></div>
<pre><code>## Error in (function (..., row.names = NULL, check.rows = FALSE, check.names = TRUE, : arguments imply differing number of rows: 2, 3</code></pre>
<p>Lists are very flexible. For example, each element of a list can have its own data type:</p>
<div class="sourceCode" id="cb454"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb454-1"><a href="functions.html#cb454-1"></a><span class="kw">tibble</span>(<span class="dt">new_col =</span> <span class="kw">list</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>,</span>
<span id="cb454-2"><a href="functions.html#cb454-2"></a>                      <span class="kw">c</span>(<span class="st">"Alice"</span>, <span class="st">"Bob"</span>))) <span class="op">%&gt;%</span></span>
<span id="cb454-3"><a href="functions.html#cb454-3"></a><span class="st">  </span><span class="kw">str</span>()</span></code></pre></div>
<pre><code>## tibble [2 × 1] (S3: tbl_df/tbl/data.frame)
##  $ new_col:List of 2
##   ..$ : int [1:2] 1 2
##   ..$ : chr [1:2] "Alice" "Bob"</code></pre>
<p>Now the first element consists of the integers 1 and 2 while the second is a character vector containing “Alice” and “Bob”.</p>
<p>We wrapped “Alice” and “Bob” in <code>c()</code> in order to make it clear that this is a vector. If we hadn’t done that, we would have three elements in our list: the vector with 1 and 2, “Alice”, and “Bob”:</p>
<div class="sourceCode" id="cb456"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb456-1"><a href="functions.html#cb456-1"></a><span class="kw">tibble</span>(<span class="dt">new_col =</span> <span class="kw">list</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>,</span>
<span id="cb456-2"><a href="functions.html#cb456-2"></a>                      <span class="st">"Alice"</span>,</span>
<span id="cb456-3"><a href="functions.html#cb456-3"></a>                      <span class="st">"Bob"</span>)) <span class="op">%&gt;%</span></span>
<span id="cb456-4"><a href="functions.html#cb456-4"></a><span class="st">  </span><span class="kw">str</span>()</span></code></pre></div>
<pre><code>## tibble [3 × 1] (S3: tbl_df/tbl/data.frame)
##  $ new_col:List of 3
##   ..$ : int [1:2] 1 2
##   ..$ : chr "Alice"
##   ..$ : chr "Bob"</code></pre>
</div>
<div id="creating-list-columns-with-mutate" class="section level3">
<h3>
<span class="header-section-number">4.2.2</span> Creating list columns with <code>mutate()</code>
</h3>
<p>Any function that returns multiple values can be used to create a list column. For example, consider the following tibble:</p>
<div class="sourceCode" id="cb458"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb458-1"><a href="functions.html#cb458-1"></a><span class="kw">tibble</span>(<span class="dt">col_1 =</span> <span class="kw">c</span>(<span class="st">"Alice and Bob"</span>, <span class="st">"Carol and Dan"</span>))</span></code></pre></div>
<p><code>col_1</code> is a character vector with two observations: “Alice and Bob” and “Carol and Dan”. The tibble has two rows. It may be more useful to present these as vectors of names, without the annoying “and” in between. That’s exactly what we can do with <code>str_split()</code>:</p>
<div class="sourceCode" id="cb459"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb459-1"><a href="functions.html#cb459-1"></a><span class="kw">tibble</span>(<span class="dt">col_1 =</span> <span class="kw">c</span>(<span class="st">"Alice and Bob"</span>, <span class="st">"Carol and Dan"</span>)) <span class="op">%&gt;%</span></span>
<span id="cb459-2"><a href="functions.html#cb459-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">col_2 =</span> <span class="kw">str_split</span>(col_<span class="dv">1</span>, <span class="st">" and "</span>)) <span class="op">%&gt;%</span></span>
<span id="cb459-3"><a href="functions.html#cb459-3"></a><span class="st">  </span><span class="kw">str</span>()</span></code></pre></div>
<pre><code>## tibble [2 × 2] (S3: tbl_df/tbl/data.frame)
##  $ col_1: chr [1:2] "Alice and Bob" "Carol and Dan"
##  $ col_2:List of 2
##   ..$ : chr [1:2] "Alice" "Bob"
##   ..$ : chr [1:2] "Carol" "Dan"</code></pre>
<p>After using <code>str_split()</code> within <code>mutate()</code>, we have created a new column, and that new column is a list column.</p>
<p>This is often how we will go about creating list columns. Let’s practice with the <code>kenya</code> dataset. How could we add a column to the dataset that included the quantiles of the <code>poverty</code> variable?</p>
<div class="sourceCode" id="cb461"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb461-1"><a href="functions.html#cb461-1"></a><span class="kw">library</span>(PPBDS.data)</span>
<span id="cb461-2"><a href="functions.html#cb461-2"></a>kenya <span class="op">%&gt;%</span></span>
<span id="cb461-3"><a href="functions.html#cb461-3"></a><span class="st">  </span><span class="kw">group_by</span>(block) <span class="op">%&gt;%</span></span>
<span id="cb461-4"><a href="functions.html#cb461-4"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">povertyQuantile =</span> <span class="kw">list</span>(<span class="kw">quantile</span>(poverty)))</span></code></pre></div>
<pre><code>## # A tibble: 1,672 x 10
## # Groups:   block [279]
##    block poll_station treatment poverty distance pop_density mean_age reg_byrv13
##    &lt;chr&gt; &lt;chr&gt;        &lt;fct&gt;       &lt;dbl&gt;    &lt;dbl&gt;       &lt;dbl&gt;    &lt;dbl&gt;      &lt;dbl&gt;
##  1 KWAL… 007/001      control     0.247     22.0    0.00296      39.6    0.00358
##  2 KWAL… 007/004      local + …   0.329     25.1    0.000888     43.8    0.0742 
##  3 KWAL… 007/009      local       0.263     27.8    0.00184      34.7    0.00691
##  4 KWAL… 007/011      local + …   0.429     27.2    0.000270     44.6    0.26   
##  5 KWAL… 007/017      local + …   0.341     19.3    0.000544     39.0    0.0228 
##  6 KWAL… 007/018      local       0.204     24.0    0.00798      37.1    0.00243
##  7 KWAL… 007/019      SMS         0.272     25.1    0.00167      39.2    0.00487
##  8 KWAL… 007/020      control     0.316     23.8    0.000538     36.3    0      
##  9 KWAL… 007/022      canvass     0.396     20.5    0.000216     42.9    0.00575
## 10 KWAL… 007/023      local + …   0.398     14.5    0.000148     39.8    0.0360 
## # … with 1,662 more rows, and 2 more variables: rv13 &lt;dbl&gt;,
## #   povertyQuantile &lt;list&gt;</code></pre>
<p><em>Note</em>: <code>str_split()</code> was a particularly easy function for using with <code>mutate()</code> and <code>summarize()</code> because it returns a list. You can check this by running <code>typeof()</code> on the output of <code>str_split()</code>: e.g., <code>str_split("Alice and Bob", " and ") %&gt;% typeof()</code>. If a function returns multiple values as a vector, like <code>quantile()</code> does, you can’t use it directly in <code>mutate()</code> or <code>summarize()</code>, but you can wrap <code>list()</code> around it in order to get the same behavior.</p>
<!-- DK: The above bit should be explained at the beginning when we review lists. -->
<p>Or let’s say that we wanted 1) to subset the dataset to the those with <code>treatment == "control"</code>, 2) group by <code>block</code>, and 3) get a <code>summary()</code> of the <code>distance</code> variable by continent:</p>
<div class="sourceCode" id="cb463"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb463-1"><a href="functions.html#cb463-1"></a>kenya <span class="op">%&gt;%</span></span>
<span id="cb463-2"><a href="functions.html#cb463-2"></a><span class="st">  </span><span class="kw">filter</span>(treatment <span class="op">==</span><span class="st"> "control"</span>) <span class="op">%&gt;%</span></span>
<span id="cb463-3"><a href="functions.html#cb463-3"></a><span class="st">  </span><span class="kw">group_by</span>(block) <span class="op">%&gt;%</span></span>
<span id="cb463-4"><a href="functions.html#cb463-4"></a><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">distSummary =</span> <span class="kw">list</span>(<span class="kw">summary</span>(distance)))</span></code></pre></div>
<pre><code>## `summarise()` ungrouping output (override with `.groups` argument)</code></pre>
<pre><code>## # A tibble: 278 x 2
##    block      distSummary
##    &lt;chr&gt;      &lt;list&gt;     
##  1 BUNGOMA/1  &lt;table [6]&gt;
##  2 BUNGOMA/10 &lt;table [6]&gt;
##  3 BUNGOMA/11 &lt;table [6]&gt;
##  4 BUNGOMA/12 &lt;table [6]&gt;
##  5 BUNGOMA/13 &lt;table [6]&gt;
##  6 BUNGOMA/14 &lt;table [6]&gt;
##  7 BUNGOMA/15 &lt;table [6]&gt;
##  8 BUNGOMA/16 &lt;table [6]&gt;
##  9 BUNGOMA/17 &lt;table [6]&gt;
## 10 BUNGOMA/18 &lt;table [6]&gt;
## # … with 268 more rows</code></pre>
</div>
<div id="map_-functions" class="section level3">
<h3>
<span class="header-section-number">4.2.3</span> <code>map_*</code> functions</h3>
<p>What can we do with a list column? That is tricky! Lists are hard to work with. But the most natural thing to do with a list is to feed it to a <code>map_*</code> function. What are these functions?</p>
<p>Let’s say that you want to find the square root of a variable in a tibble, storing the result in <code>x</code>. You could accomplish this with <code>mutate</code>:</p>
<div class="sourceCode" id="cb466"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb466-1"><a href="functions.html#cb466-1"></a><span class="kw">tibble</span>(<span class="dt">start =</span> <span class="kw">c</span>(<span class="dv">3</span>, <span class="fl">2.5</span>, <span class="dv">6</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb466-2"><a href="functions.html#cb466-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">new =</span> <span class="kw">sqrt</span>(start))</span></code></pre></div>
<pre><code>## # A tibble: 3 x 2
##   start   new
##   &lt;dbl&gt; &lt;dbl&gt;
## 1   3    1.73
## 2   2.5  1.58
## 3   6    2.45</code></pre>
<p>Or, we can use <code>map_dbl()</code> to apply this to our input variable. <code>map_dbl()</code> — pronounced “map double” — comes from the <strong>purrr</strong> package, which you will have loaded if you have loaded <strong>tidyverse</strong>. <code>map_dbl()</code> is just one member of a family of <code>map_*</code> functions which applies the same function to every row in a tibble. The “dbl” suffix indicates that the function returns a “double,” meaning a numeric value.</p>
<div class="sourceCode" id="cb468"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb468-1"><a href="functions.html#cb468-1"></a><span class="kw">tibble</span>(<span class="dt">start =</span> <span class="kw">c</span>(<span class="dv">3</span>, <span class="fl">2.5</span>, <span class="dv">6</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb468-2"><a href="functions.html#cb468-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">new =</span> <span class="kw">map_dbl</span>(start, sqrt))</span></code></pre></div>
<pre><code>## # A tibble: 3 x 2
##   start   new
##   &lt;dbl&gt; &lt;dbl&gt;
## 1   3    1.73
## 2   2.5  1.58
## 3   6    2.45</code></pre>
<p><code>map_dbl()</code> took the function <code>sqrt()</code> and applied it to each element of <code>start</code>. Note that, when we passed the function <code>sqrt()</code> to <code>map_dbl()</code>, we passed in just its name, without the closing parentheses. This code fails:</p>
<div class="sourceCode" id="cb470"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb470-1"><a href="functions.html#cb470-1"></a><span class="kw">tibble</span>(<span class="dt">start =</span> <span class="kw">c</span>(<span class="dv">3</span>, <span class="fl">2.5</span>, <span class="dv">6</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb470-2"><a href="functions.html#cb470-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">new =</span> <span class="kw">map_dbl</span>(start, <span class="kw">sqrt</span>()))</span></code></pre></div>
<pre><code>## Error: Problem with `mutate()` input `new`.
## x 0 arguments passed to 'sqrt' which requires 1
## ℹ Input `new` is `map_dbl(start, sqrt())`.</code></pre>
<p><code>sqrt()</code> with the parentheses is a call to the function. So, the first thing R tries to do is to run the function. Doing so fails because <code>sqrt()</code> requires an argument <code>x</code>, which is empty.</p>
<p><label for="tufte-mn-43" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-43" class="margin-toggle"><span class="marginnote"><span style="display: block;">Lesson: When passing a function in to <code>map_*</code> functions, pass just the name.</span></span></p>
<p>We called these <code>map_*</code> <em>functions</em> (plural) before. If you know the expected output of your function, you can specify that kind of vector:</p>
<ul>
<li>
<code>map()</code>: list<br>
</li>
<li>
<code>map_lgl()</code>: logical</li>
<li>
<code>map_int()</code>: integer</li>
<li>
<code>map_dbl()</code>: double (numeric)</li>
<li>
<code>map_chr()</code>: character</li>
<li>
<code>map_df()</code>: data frame</li>
</ul>
<p>So, since our example produces numeric output, we use <code>map_dbl()</code> instead of <code>map()</code>.</p>
<p>Now, you may be wondering, what’s the difference between using <code>mutate()</code> and <code>map_*</code> functions? After all, the example above demonstrated a use case in which both were used interchangeably. The answer lies in iteration, which is the specialization of the <strong>purrr</strong> package. <code>map_*</code> functions are powerful because of their ability to create list-columns and to apply functions to every single element of a list, which <code>mutate()</code> cannot handle. We’ll show you exactly what we mean in the next example.</p>
</div>
<div id="using-map_-functions-to-create-list-columns" class="section level3">
<h3>
<span class="header-section-number">4.2.4</span> Using <code>map_*</code> functions to create list-columns</h3>
<p>For this example, we will use the <code>nhanes</code> dataset from the <code>PPBDS.data</code> package to demonstrate how to use <code>map_*</code> functions to create list columns.</p>
<p>First, let’s wrangle the data so each observation is grouped by age and gender. We’ll create a list column <code>all_weights</code> that consists of every subject’s weight, grouped by age and gender.</p>
<div class="sourceCode" id="cb472"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb472-1"><a href="functions.html#cb472-1"></a>nhanes <span class="op">%&gt;%</span></span>
<span id="cb472-2"><a href="functions.html#cb472-2"></a><span class="st">  </span><span class="kw">group_by</span>(age, gender) <span class="op">%&gt;%</span></span>
<span id="cb472-3"><a href="functions.html#cb472-3"></a><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">all_weights =</span> <span class="kw">list</span>(weight))</span></code></pre></div>
<p>Now that we have a list column, we can use it as the input to <code>map()</code>, outputting another list column. Let’s say we wanted a new list column, <code>log_weights</code>, which takes the logarithmic value of each weight observation.</p>
<div class="sourceCode" id="cb473"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb473-1"><a href="functions.html#cb473-1"></a>nhanes <span class="op">%&gt;%</span></span>
<span id="cb473-2"><a href="functions.html#cb473-2"></a><span class="st">  </span><span class="kw">group_by</span>(age, gender) <span class="op">%&gt;%</span></span>
<span id="cb473-3"><a href="functions.html#cb473-3"></a><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">all_weights =</span> <span class="kw">list</span>(weight)) <span class="op">%&gt;%</span></span>
<span id="cb473-4"><a href="functions.html#cb473-4"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">log_weights =</span> <span class="kw">map</span>(all_weights, log))</span></code></pre></div>
<p>Note that we took the list column <code>all_weights</code> and, by applying an anonymous function to it with <code>map()</code>, created another list column <code>log_weights</code>. This is a very common process. It is similar to taking a tibble and piping it into a <code>dplyr</code> function (such as <code>mutate()</code>) which gives you a new tibble that you can work with.</p>
<p>If we try to replace the <code>map()</code> function in the last line with a simple <code>mutate()</code>, we will get an error.</p>
<pre><code>## `summarise()` regrouping output by 'age' (override with `.groups` argument)</code></pre>
<pre><code>## Error: Problem with `mutate()` input `log_weights`.
## x non-numeric argument to mathematical function
## ℹ Input `log_weights` is `log(all_weights)`.
## ℹ The error occured in group 1: age = 0.</code></pre>
<p>Again, this is because the <code>mutate()</code> function is ill-equipped to handle lists. We could have avoided creating the list-columns in the first place and found the log weight of each observation, but then we would be losing out on the grouping ability of lists. Do you see how <code>map_*</code> functions are equipped to handle inputs different from <code>mutate()</code>?</p>
<p>You can also use <code>map_*</code> functions to take a list column as an input and return an atomic vector – a column with a single value per observation – as an output. For instance, let’s say we now wanted the mean of the log weights:</p>
<div class="sourceCode" id="cb476"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb476-1"><a href="functions.html#cb476-1"></a>nhanes <span class="op">%&gt;%</span></span>
<span id="cb476-2"><a href="functions.html#cb476-2"></a><span class="st">  </span><span class="kw">group_by</span>(age, gender) <span class="op">%&gt;%</span></span>
<span id="cb476-3"><a href="functions.html#cb476-3"></a><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">all_weights =</span> <span class="kw">list</span>(weight)) <span class="op">%&gt;%</span></span>
<span id="cb476-4"><a href="functions.html#cb476-4"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">log_weights =</span> <span class="kw">map</span>(all_weights, log),</span>
<span id="cb476-5"><a href="functions.html#cb476-5"></a>         <span class="dt">mean_log_weights =</span> <span class="kw">map_dbl</span>(log_weights, mean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))</span></code></pre></div>
<p>Here, we also see that the <code>map_*</code> functions have the <code>...</code> argument, which allows <code>na.rm = TRUE</code> to be passed along to <code>mean()</code>.</p>
<p>What if we wanted to extract the top five log weights per row?</p>
<div class="sourceCode" id="cb477"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb477-1"><a href="functions.html#cb477-1"></a>nhanes <span class="op">%&gt;%</span></span>
<span id="cb477-2"><a href="functions.html#cb477-2"></a><span class="st">  </span><span class="kw">group_by</span>(age, gender) <span class="op">%&gt;%</span></span>
<span id="cb477-3"><a href="functions.html#cb477-3"></a><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">all_weights =</span> <span class="kw">list</span>(weight)) <span class="op">%&gt;%</span></span>
<span id="cb477-4"><a href="functions.html#cb477-4"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">log_weights =</span> <span class="kw">map</span>(all_weights, log),</span>
<span id="cb477-5"><a href="functions.html#cb477-5"></a>         <span class="dt">sorted_log_weights =</span> <span class="kw">map</span>(log_weights, <span class="op">~</span><span class="st"> </span><span class="kw">sort</span>(., <span class="dt">decreasing =</span> <span class="ot">TRUE</span>)),</span>
<span id="cb477-6"><a href="functions.html#cb477-6"></a>         <span class="dt">top5_log_weights =</span> <span class="kw">map</span>(sorted_log_weights, <span class="op">~</span><span class="st"> </span>.[<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>]))</span></code></pre></div>
<p>See how we chained the <code>map_*</code> functions:</p>
<ol style="list-style-type: decimal">
<li>
<code>all_weights</code> was used as the input to <code>map()</code> to create <code>log_weights</code>
</li>
<li>
<code>log_weights</code> was used as the input to <code>map()</code> to create <code>sorted_log_weights</code>
</li>
<li>
<code>sorted_log_weights</code> was used as the input to <code>map()</code> to create <code>top5_log_weights</code>
</li>
</ol>
<p>Later on, we will practice using map functions to create list columns with custom functions, not just built-in R functions. You will see that <code>map_*</code> functions are highly versatile!</p>
<!-- This is where we need to fill in the gap between map functions and functions in general -->
</div>
</div>
<div id="built-in-functions-and-custom-functions" class="section level2">
<h2>
<span class="header-section-number">4.3</span> Built-In Functions and Custom Functions</h2>
<div id="building-your-first-custom-function" class="section level3">
<h3>
<span class="header-section-number">4.3.1</span> Building your first custom function</h3>
<!-- EC: I still like the basic introducton to building a function, so I replaced gapminder with `kenya`. Thoughts? -->
<p>Let’s examine the <code>kenya</code> dataset from <code>PPBDS.data</code>. What if we were interested in taking the difference between the highest poverty rate and the lowest poverty rate? First, develop some working code for interactive use, using a representative input. Use the <code>poverty</code> variable. Built-in R functions that will be useful: <code>min()</code>, <code>max()</code>, <code>range()</code>.</p>
<div class="sourceCode" id="cb478"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb478-1"><a href="functions.html#cb478-1"></a><span class="co"># Get to know the functions mentioned above</span></span>
<span id="cb478-2"><a href="functions.html#cb478-2"></a></span>
<span id="cb478-3"><a href="functions.html#cb478-3"></a><span class="kw">min</span>(kenya<span class="op">$</span>poverty)</span></code></pre></div>
<pre><code>## [1] 0.18</code></pre>
<div class="sourceCode" id="cb480"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb480-1"><a href="functions.html#cb480-1"></a><span class="kw">max</span>(kenya<span class="op">$</span>poverty)</span></code></pre></div>
<pre><code>## [1] 0.9</code></pre>
<div class="sourceCode" id="cb482"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb482-1"><a href="functions.html#cb482-1"></a><span class="kw">range</span>(kenya<span class="op">$</span>poverty)</span></code></pre></div>
<pre><code>## [1] 0.18 0.90</code></pre>
<div class="sourceCode" id="cb484"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb484-1"><a href="functions.html#cb484-1"></a><span class="co"># Some natural solutions</span></span>
<span id="cb484-2"><a href="functions.html#cb484-2"></a></span>
<span id="cb484-3"><a href="functions.html#cb484-3"></a><span class="kw">max</span>(kenya<span class="op">$</span>poverty) <span class="op">-</span><span class="st"> </span><span class="kw">min</span>(kenya<span class="op">$</span>poverty)</span></code></pre></div>
<pre><code>## [1] 0.72</code></pre>
<div class="sourceCode" id="cb486"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb486-1"><a href="functions.html#cb486-1"></a><span class="kw">with</span>(kenya, <span class="kw">max</span>(poverty) <span class="op">-</span><span class="st"> </span><span class="kw">min</span>(poverty))</span></code></pre></div>
<pre><code>## [1] 0.72</code></pre>
<div class="sourceCode" id="cb488"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb488-1"><a href="functions.html#cb488-1"></a><span class="kw">range</span>(kenya<span class="op">$</span>poverty)[<span class="dv">2</span>] <span class="op">-</span><span class="st"> </span><span class="kw">range</span>(kenya<span class="op">$</span>poverty)[<span class="dv">1</span>]</span></code></pre></div>
<pre><code>## [1] 0.72</code></pre>
<div class="sourceCode" id="cb490"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb490-1"><a href="functions.html#cb490-1"></a><span class="kw">with</span>(kenya, <span class="kw">range</span>(poverty)[<span class="dv">2</span>] <span class="op">-</span><span class="st"> </span><span class="kw">range</span>(poverty)[<span class="dv">1</span>])</span></code></pre></div>
<pre><code>## [1] 0.72</code></pre>
<div class="sourceCode" id="cb492"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb492-1"><a href="functions.html#cb492-1"></a><span class="kw">diff</span>(<span class="kw">range</span>(kenya<span class="op">$</span>poverty))</span></code></pre></div>
<pre><code>## [1] 0.72</code></pre>
<p>Internalize this “answer” because our informal testing relies on you noticing departures from this.</p>
</div>
<div id="skateboard-perfectly-formed-rear-view-mirror" class="section level3">
<h3>
<span class="header-section-number">4.3.2</span> Skateboard &gt;&gt; perfectly formed rear-view mirror</h3>
<p>This image — widely attributed to the Spotify development team — conveys an important point.</p>
<div class="figure">
<span id="fig:spotify-howtobuildmvp"></span>
<p class="caption marginnote shownote">
FIGURE 4.1: From <a href="https://blog.fastmonkeys.com/2014/06/18/minimum-viable-product-your-ultimate-guide-to-mvp-great-examples/">Your ultimate guide to Minimum Viable Product (+great examples)</a>
</p>
<img src="04-functions/images/mvp.jpg" alt="From [Your ultimate guide to Minimum Viable Product (+great examples)](https://blog.fastmonkeys.com/2014/06/18/minimum-viable-product-your-ultimate-guide-to-mvp-great-examples/)" width="60%">
</div>
<p>Build that skateboard before you build the car or some fancy car part. A limited-but-functioning thing is very useful. It also keeps the spirits high.</p>
<p>This is related to the valuable Telescope Rule:</p>
<blockquote>
<p>It is faster to make a four-inch mirror and then a six-inch mirror than it is to make a six-inch mirror.</p>
</blockquote>
</div>
<div id="turn-the-working-interactive-code-into-a-function" class="section level3">
<h3>
<span class="header-section-number">4.3.3</span> Turn the working interactive code into a function</h3>
<p>Add NO new functionality! Just write your very first R function.</p>
<div class="sourceCode" id="cb494"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb494-1"><a href="functions.html#cb494-1"></a>max_minus_min &lt;-<span class="st"> </span><span class="cf">function</span>(x) <span class="kw">max</span>(x) <span class="op">-</span><span class="st"> </span><span class="kw">min</span>(x)</span>
<span id="cb494-2"><a href="functions.html#cb494-2"></a><span class="kw">max_minus_min</span>(kenya<span class="op">$</span>poverty)</span></code></pre></div>
<pre><code>## [1] 0.72</code></pre>
<p>Check that you’re getting the same answer as you did with your interactive code. Test it eyeball-o-metrically at this point.</p>
<p>One thing to note about functions is that functions have selective memory. In fact, functions only “remember” what happens within the function itself.</p>
<p>For example, I have saved value <code>x</code> as 1.</p>
<div class="sourceCode" id="cb496"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb496-1"><a href="functions.html#cb496-1"></a>x &lt;-<span class="st"> </span><span class="dv">1</span></span></code></pre></div>
<p>Defining <code>x</code> inside a function will not change its value outside of the function.</p>
<div class="sourceCode" id="cb497"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb497-1"><a href="functions.html#cb497-1"></a><span class="cf">function</span>(x) x &lt;-<span class="st"> </span><span class="dv">2</span></span></code></pre></div>
<pre><code>## function(x) x &lt;- 2</code></pre>
<div class="sourceCode" id="cb499"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb499-1"><a href="functions.html#cb499-1"></a>x</span></code></pre></div>
<pre><code>## [1] 1</code></pre>
</div>
<div id="test-your-function" class="section level3">
<h3>
<span class="header-section-number">4.3.4</span> Test your function</h3>
<div id="test-on-new-inputs" class="section level4">
<h4>
<span class="header-section-number">4.3.4.1</span> Test on new inputs</h4>
<p>Pick some new artificial inputs where you know (at least approximately) what your function should return.</p>
<div class="sourceCode" id="cb501"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb501-1"><a href="functions.html#cb501-1"></a><span class="kw">max_minus_min</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)</span></code></pre></div>
<pre><code>## [1] 9</code></pre>
<div class="sourceCode" id="cb503"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb503-1"><a href="functions.html#cb503-1"></a><span class="kw">max_minus_min</span>(<span class="kw">runif</span>(<span class="dv">1000</span>))</span></code></pre></div>
<pre><code>## [1] 1</code></pre>
<p>I know that 10 minus 1 is 9. I know that random uniform [0, 1] variates will be between 0 and 1. Therefore max - min should be less than 1. If I take LOTS of them, max - min should be pretty close to 1.</p>
<p>It is intentional that I tested on integer input as well as floating point. Likewise, I like to use valid-but-random data for this sort of check.</p>
</div>
<div id="test-on-real-data-but-different-real-data" class="section level4">
<h4>
<span class="header-section-number">4.3.4.2</span> Test on real data but <em>different</em> real data</h4>
<p>Back to the real world now. Two additional quantitative variables are lying around: <code>distance</code> and <code>rv13</code>. Let’s have a go.</p>
<div class="sourceCode" id="cb505"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb505-1"><a href="functions.html#cb505-1"></a><span class="kw">max_minus_min</span>(kenya<span class="op">$</span>distance)</span></code></pre></div>
<pre><code>## [1] 179</code></pre>
<div class="sourceCode" id="cb507"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb507-1"><a href="functions.html#cb507-1"></a><span class="kw">max_minus_min</span>(kenya<span class="op">$</span>rv13)</span></code></pre></div>
<pre><code>## [1] 6764</code></pre>
<p>Either check these results “by hand” or apply the “does that even make sense?” test.</p>
</div>
<div id="test-on-weird-stuff" class="section level4">
<h4>
<span class="header-section-number">4.3.4.3</span> Test on weird stuff</h4>
<p>Now we try to break our function. Don’t get truly diabolical (yet). Just make the kind of mistakes you can imagine making at 2am when, 3 years from now, you rediscover this useful function you wrote. Give your function inputs it’s not expecting.</p>
<div class="sourceCode" id="cb509"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb509-1"><a href="functions.html#cb509-1"></a><span class="kw">max_minus_min</span>(kenya)</span></code></pre></div>
<pre><code>## Error in FUN(X[[i]], ...): only defined on a data frame with all numeric variables</code></pre>
<div class="sourceCode" id="cb511"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb511-1"><a href="functions.html#cb511-1"></a><span class="co"># Hey, sometimes things "just work" on data.frames!</span></span>
<span id="cb511-2"><a href="functions.html#cb511-2"></a></span>
<span id="cb511-3"><a href="functions.html#cb511-3"></a><span class="kw">max_minus_min</span>(kenya<span class="op">$</span>treatment)</span></code></pre></div>
<pre><code>## Error in Summary.factor(structure(c(2L, 4L, 3L, 5L, 4L, 3L, 6L, 2L, 1L, : 'max' not meaningful for factors</code></pre>
<div class="sourceCode" id="cb513"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb513-1"><a href="functions.html#cb513-1"></a><span class="co"># Factors are kind of like integer vectors, no?</span></span>
<span id="cb513-2"><a href="functions.html#cb513-2"></a></span>
<span id="cb513-3"><a href="functions.html#cb513-3"></a><span class="kw">max_minus_min</span>(<span class="st">"eggplants are purple"</span>)</span></code></pre></div>
<pre><code>## Error in max(x) - min(x): non-numeric argument to binary operator</code></pre>
<div class="sourceCode" id="cb515"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb515-1"><a href="functions.html#cb515-1"></a><span class="co"># I have no excuse for this one</span></span></code></pre></div>
<p>How happy are you with those error messages? You must imagine that some entire <strong>script</strong> has failed and that you were hoping to just <code>source()</code> it without re-reading it. If a colleague or future you encountered these errors, do you run screaming from the room? How hard is it to pinpoint the usage problem?</p>
</div>
<div id="i-will-scare-you-now" class="section level4">
<h4>
<span class="header-section-number">4.3.4.4</span> I will scare you now</h4>
<p>Here are some great examples where the function <strong>should break but it does not.</strong></p>
<div class="sourceCode" id="cb516"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb516-1"><a href="functions.html#cb516-1"></a><span class="kw">max_minus_min</span>(kenya[<span class="kw">c</span>(<span class="st">'poverty'</span>, <span class="st">'distance'</span>, <span class="st">'rv13'</span>)])</span></code></pre></div>
<pre><code>## [1] 6764</code></pre>
<div class="sourceCode" id="cb518"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb518-1"><a href="functions.html#cb518-1"></a><span class="kw">max_minus_min</span>(<span class="kw">c</span>(<span class="ot">TRUE</span>, <span class="ot">TRUE</span>, <span class="ot">FALSE</span>, <span class="ot">TRUE</span>, <span class="ot">TRUE</span>))</span></code></pre></div>
<pre><code>## [1] 1</code></pre>
<p>In both cases, R’s eagerness to make sense of our requests is unfortunately successful. In the first case, a tibble containing just the quantitative variables is eventually coerced into numeric vector. We can compute max minus min, even though it makes absolutely no sense at all. In the second case, a logical vector is converted to zeroes and ones, which might merit an error or at least a warning.</p>
</div>
</div>
<div id="check-the-validity-of-arguments" class="section level3">
<h3>
<span class="header-section-number">4.3.5</span> Check the validity of arguments</h3>
<p>For functions that will be used again – which is not all of them! – it is good to check the validity of arguments. This implements a rule from the Unix philosophy:</p>
<blockquote>
<p>Rule of Repair: When you must fail, fail noisily and as soon as possible.</p>
</blockquote>
<div id="stop-if-not" class="section level4">
<h4>
<span class="header-section-number">4.3.5.1</span> stop if not</h4>
<p><code>stopifnot()</code> is the entry level solution. We use it here to make sure the input <code>x</code> is a numeric vector.</p>
<div class="sourceCode" id="cb520"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb520-1"><a href="functions.html#cb520-1"></a>mmm &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</span>
<span id="cb520-2"><a href="functions.html#cb520-2"></a>  <span class="kw">stopifnot</span>(<span class="kw">is.numeric</span>(x))</span>
<span id="cb520-3"><a href="functions.html#cb520-3"></a>  <span class="kw">max</span>(x) <span class="op">-</span><span class="st"> </span><span class="kw">min</span>(x)</span>
<span id="cb520-4"><a href="functions.html#cb520-4"></a>}</span>
<span id="cb520-5"><a href="functions.html#cb520-5"></a><span class="kw">mmm</span>(kenya)</span></code></pre></div>
<pre><code>## Error in mmm(kenya): is.numeric(x) is not TRUE</code></pre>
<div class="sourceCode" id="cb522"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb522-1"><a href="functions.html#cb522-1"></a><span class="kw">mmm</span>(kenya<span class="op">$</span>treatment)</span></code></pre></div>
<pre><code>## Error in mmm(kenya$treatment): is.numeric(x) is not TRUE</code></pre>
<div class="sourceCode" id="cb524"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb524-1"><a href="functions.html#cb524-1"></a><span class="kw">mmm</span>(<span class="st">"eggplants are purple"</span>)</span></code></pre></div>
<pre><code>## Error in mmm("eggplants are purple"): is.numeric(x) is not TRUE</code></pre>
<div class="sourceCode" id="cb526"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb526-1"><a href="functions.html#cb526-1"></a><span class="kw">mmm</span>(kenya[<span class="kw">c</span>(<span class="st">'poverty'</span>, <span class="st">'distance'</span>, <span class="st">'rv13'</span>)])</span></code></pre></div>
<pre><code>## Error in mmm(kenya[c("poverty", "distance", "rv13")]): is.numeric(x) is not TRUE</code></pre>
<div class="sourceCode" id="cb528"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb528-1"><a href="functions.html#cb528-1"></a><span class="kw">mmm</span>(<span class="kw">c</span>(<span class="ot">TRUE</span>, <span class="ot">TRUE</span>, <span class="ot">FALSE</span>, <span class="ot">TRUE</span>, <span class="ot">TRUE</span>))</span></code></pre></div>
<pre><code>## Error in mmm(c(TRUE, TRUE, FALSE, TRUE, TRUE)): is.numeric(x) is not TRUE</code></pre>
<p>And we see that it catches all of the self-inflicted damage we would like to avoid.</p>
</div>
<div id="if-then-stop" class="section level4">
<h4>
<span class="header-section-number">4.3.5.2</span> if then stop</h4>
<p><code>stopifnot()</code> doesn’t provide a very good error message. The next approach is very widely used. Put your validity check inside an <code>if()</code> statement and call <code>stop()</code> yourself, with a custom error message, in the body.</p>
<div class="sourceCode" id="cb530"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb530-1"><a href="functions.html#cb530-1"></a>mmm2 &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</span>
<span id="cb530-2"><a href="functions.html#cb530-2"></a>  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.numeric</span>(x)) {</span>
<span id="cb530-3"><a href="functions.html#cb530-3"></a>    <span class="kw">stop</span>(<span class="st">'I am so sorry, but this function only works for numeric input!</span><span class="ch">\n</span><span class="st">'</span>,</span>
<span id="cb530-4"><a href="functions.html#cb530-4"></a>         <span class="st">'You have provided an object of class: '</span>, <span class="kw">class</span>(x)[<span class="dv">1</span>])</span>
<span id="cb530-5"><a href="functions.html#cb530-5"></a>  }</span>
<span id="cb530-6"><a href="functions.html#cb530-6"></a>  <span class="kw">max</span>(x) <span class="op">-</span><span class="st"> </span><span class="kw">min</span>(x)</span>
<span id="cb530-7"><a href="functions.html#cb530-7"></a>}</span>
<span id="cb530-8"><a href="functions.html#cb530-8"></a><span class="kw">mmm2</span>(kenya)</span></code></pre></div>
<pre><code>## Error in mmm2(kenya): I am so sorry, but this function only works for numeric input!
## You have provided an object of class: tbl_df</code></pre>
<p><label for="tufte-mn-44" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-44" class="margin-toggle"><span class="marginnote"><span style="display: block;"><strong>Non-programming uses for assertions</strong></span>
<span style="display: block;">Another good use of this pattern is to leave checks behind in data analytical scripts. If we were loading from file (vs. a stable data package), we might want to formalize our expectations about the number of rows and columns, the names and flavors of the variables, etc. This would alert us if the data suddenly changed, which can be a useful wake-up call in scripts that you re-run <em>ad nauseam</em> on auto-pilot or non-interactively.</span></span></p>
<p>In addition to a gratuitous apology, the error also contains two more pieces of helpful info:</p>
<ul>
<li>
<em>Which</em> function threw the error.</li>
<li>Hints on how to fix things: expected class of input vs actual class.</li>
</ul>
<p>If it is easy to do so, we highly recommend this template: “you gave me THIS, but I need THAT”.</p>
<p>The tidyverse style guide has a very useful <a href="https://style.tidyverse.org/error-messages.html">chapter on how to construct error messages</a>.</p>
</div>
</div>
<div id="wrap-up-and-whats-next" class="section level3">
<h3>
<span class="header-section-number">4.3.6</span> Wrap-up and what’s next?</h3>
<p>Here’s the function we’ve written as an introduction to built-in and custom functions:</p>
<div class="sourceCode" id="cb532"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb532-1"><a href="functions.html#cb532-1"></a>mmm2</span></code></pre></div>
<pre><code>## function(x) {
##   if(!is.numeric(x)) {
##     stop('I am so sorry, but this function only works for numeric input!\n',
##          'You have provided an object of class: ', class(x)[1])
##   }
##   max(x) - min(x)
## }</code></pre>
<p>What we’ve accomplished:</p>
<ul>
<li>We’ve written our first function.</li>
<li>We are checking the validity of its input, argument <code>x</code>.</li>
<li>We’ve done a good amount of informal testing.</li>
</ul>
</div>
</div>
<div id="argument-specifications-and-a-data-generating-mechanism" class="section level2">
<h2>
<span class="header-section-number">4.4</span> Argument Specifications and a Data Generating Mechanism</h2>
<p>In this section, we create a new function and generalize it, introduce data generating mechanisms, and learn more technical details about R functions.</p>
<!-- EC: Where should this section go? Switch around this section + change title to reflect the order. -->
<div id="data-generating-mechanisms" class="section level3">
<h3>
<span class="header-section-number">4.4.1</span> Data Generating Mechanisms</h3>
<p>As data scientists, there are many reasons to generate “fake data” – as in, data that does not exist naturally in this world. Perhaps you’d like to run a simulation. Or, perhaps you want to predict a fitted value for a real world phenomena. Either way, you will realize that at one point, you would like to generate data, which will induce some element of <em>randomness</em>. See, there is no point in manually creating a dataset in which you already <em>know</em> what every observation looks like. Indeed, real life is messy and real data has a lot of variation! Next, we will be creating our own data generation mechanism through a custom function.</p>
<p>Take a look at the <code>runif()</code> and <code>rnorm()</code> functions again.</p>
<div class="sourceCode" id="cb534"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb534-1"><a href="functions.html#cb534-1"></a><span class="kw">runif</span>(<span class="dv">1</span>)</span></code></pre></div>
<pre><code>## [1] 0.86</code></pre>
<div class="sourceCode" id="cb536"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb536-1"><a href="functions.html#cb536-1"></a><span class="kw">rnorm</span>(<span class="dv">1</span>)</span></code></pre></div>
<pre><code>## [1] 0.51</code></pre>
<p>Let’s start by creating a function named <code>dgm()</code> that simply adds the two random variables shown above.</p>
<div class="sourceCode" id="cb538"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb538-1"><a href="functions.html#cb538-1"></a>dgm &lt;-<span class="st"> </span><span class="cf">function</span>() </span>
<span id="cb538-2"><a href="functions.html#cb538-2"></a>  <span class="kw">runif</span>(<span class="dv">1</span>) <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(<span class="dv">1</span>)</span></code></pre></div>
<div class="sourceCode" id="cb539"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb539-1"><a href="functions.html#cb539-1"></a><span class="kw">dgm</span>()</span></code></pre></div>
<pre><code>## [1] 1.3</code></pre>
<p>What if we wanted to add a formal argument, <code>mean</code>, that would be passed into <code>rnorm()</code>’s mean specification?</p>
<div class="sourceCode" id="cb541"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb541-1"><a href="functions.html#cb541-1"></a>dgm &lt;-<span class="st"> </span><span class="cf">function</span>(mean) </span>
<span id="cb541-2"><a href="functions.html#cb541-2"></a>  <span class="kw">runif</span>(<span class="dv">1</span>) <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(<span class="dv">1</span>, mean)</span></code></pre></div>
<p>Why stop there? Let’s add two more arguments: <code>sd</code>, which specifies the standard deviation of the normal distribution, and <code>n</code>, which specifies the number of normally distributed random variables to generate.</p>
<div class="sourceCode" id="cb542"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb542-1"><a href="functions.html#cb542-1"></a>dgm &lt;-<span class="st"> </span><span class="cf">function</span>(n, mean, sd) </span>
<span id="cb542-2"><a href="functions.html#cb542-2"></a>  <span class="kw">runif</span>(<span class="dv">1</span>) <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(n, mean, sd)</span></code></pre></div>
<p>Congratulations! We have just generalized our function to take in any value for the <code>mean</code> and <code>sd</code> of the normal distribution. But wait… is it really <em>any</em> value? Let’s add in a few checks that make sure no weird inputs break our function.</p>
<div class="sourceCode" id="cb543"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb543-1"><a href="functions.html#cb543-1"></a>dgm &lt;-<span class="st"> </span><span class="cf">function</span>(n, mean, sd) {</span>
<span id="cb543-2"><a href="functions.html#cb543-2"></a>  <span class="kw">stopifnot</span>(<span class="kw">is.numeric</span>(n),</span>
<span id="cb543-3"><a href="functions.html#cb543-3"></a>            <span class="kw">is.numeric</span>(mean),</span>
<span id="cb543-4"><a href="functions.html#cb543-4"></a>            <span class="kw">is.numeric</span>(sd))</span>
<span id="cb543-5"><a href="functions.html#cb543-5"></a>  <span class="kw">runif</span>(<span class="dv">1</span>) <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(n, mean, sd)</span>
<span id="cb543-6"><a href="functions.html#cb543-6"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb544"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb544-1"><a href="functions.html#cb544-1"></a><span class="kw">dgm</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="op">-</span><span class="dv">1</span>)</span></code></pre></div>
<pre><code>## Warning in rnorm(n, mean, sd): NAs produced</code></pre>
<pre><code>## [1] NaN</code></pre>
<p>Oops! As you can see, we tried to use a negative standard deviation, which will not fly. Let’s alter the informal checks to stop the function if <code>sd</code> is negative, and let’s go ahead and do that for <code>n</code> as well - it is impossible to have a negative number of observations.</p>
<div class="sourceCode" id="cb547"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb547-1"><a href="functions.html#cb547-1"></a>dgm &lt;-<span class="st"> </span><span class="cf">function</span>(n, mean, sd) {</span>
<span id="cb547-2"><a href="functions.html#cb547-2"></a>  <span class="kw">stopifnot</span>(n <span class="op">&gt;=</span><span class="st"> </span><span class="dv">0</span>,</span>
<span id="cb547-3"><a href="functions.html#cb547-3"></a>            sd <span class="op">&gt;=</span><span class="st"> </span><span class="dv">0</span>,</span>
<span id="cb547-4"><a href="functions.html#cb547-4"></a>            <span class="kw">is.numeric</span>(n),</span>
<span id="cb547-5"><a href="functions.html#cb547-5"></a>            <span class="kw">is.numeric</span>(mean),</span>
<span id="cb547-6"><a href="functions.html#cb547-6"></a>            <span class="kw">is.numeric</span>(sd))</span>
<span id="cb547-7"><a href="functions.html#cb547-7"></a>  <span class="kw">runif</span>(<span class="dv">1</span>) <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(n, mean, sd)</span>
<span id="cb547-8"><a href="functions.html#cb547-8"></a>}</span></code></pre></div>
<p>As you can see, we have a function that works and takes in sensible arguments. Next, let’s talk about about argument specifications and conventions.</p>
</div>
<div id="argument-names-freedom-and-conventions" class="section level3">
<h3>
<span class="header-section-number">4.4.2</span> Argument names: freedom and conventions</h3>
<p>Understand the importance of argument names. We can name my arguments almost anything we like. Proof:</p>
<div class="sourceCode" id="cb548"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb548-1"><a href="functions.html#cb548-1"></a>dgm &lt;-<span class="st"> </span><span class="cf">function</span>(pie, cookie, cheesecake) {</span>
<span id="cb548-2"><a href="functions.html#cb548-2"></a>  <span class="kw">stopifnot</span>(pie <span class="op">&gt;=</span><span class="st"> </span><span class="dv">0</span>,</span>
<span id="cb548-3"><a href="functions.html#cb548-3"></a>            cheesecake <span class="op">&gt;=</span><span class="st"> </span><span class="dv">0</span>,</span>
<span id="cb548-4"><a href="functions.html#cb548-4"></a>            <span class="kw">is.numeric</span>(pie),</span>
<span id="cb548-5"><a href="functions.html#cb548-5"></a>            <span class="kw">is.numeric</span>(cookie),</span>
<span id="cb548-6"><a href="functions.html#cb548-6"></a>            <span class="kw">is.numeric</span>(cheesecake))</span>
<span id="cb548-7"><a href="functions.html#cb548-7"></a>  <span class="kw">runif</span>(<span class="dv">1</span>) <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(pie, cookie, cheesecake)</span>
<span id="cb548-8"><a href="functions.html#cb548-8"></a>}</span>
<span id="cb548-9"><a href="functions.html#cb548-9"></a></span>
<span id="cb548-10"><a href="functions.html#cb548-10"></a><span class="kw">dgm</span>(<span class="dt">pie =</span> <span class="dv">1</span>, <span class="dt">cookie =</span> <span class="dv">0</span>, <span class="dt">cheesecake =</span> <span class="dv">1</span>)</span></code></pre></div>
<pre><code>## [1] -0.51</code></pre>
<p>While we can name my arguments after common desserts, it’s usually a bad idea. Take all opportunities to make things more self-explanatory via meaningful names.</p>
<p>If you are going to pass the arguments of your function as arguments of a built-in function, consider copying the argument names. Unless you have a good reason to do your own thing (some argument names are bad!), be consistent with the existing function. Again, the reason is to reduce your cognitive load.</p>
<p>We took this detour so you could see there is no <em>structural</em> relationship between our arguments (<code>n</code>, <code>mean</code>, and <code>sd</code>) and those of <code>quantile()</code> (also <code>n</code>, <code>mean</code>, and <code>sd</code>). The similarity or equivalence of the names <strong>accomplishes nothing</strong> as far as R is concerned; it is solely for the benefit of humans reading, writing, and using the code. Which is very important!</p>
</div>
<div id="default-values-freedom-to-not-specify-the-arguments" class="section level3">
<h3>
<span class="header-section-number">4.4.3</span> Default values: freedom to NOT specify the arguments</h3>
<p>What happens if we call our function but neglect to specify the probabilities?</p>
<div class="sourceCode" id="cb550"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb550-1"><a href="functions.html#cb550-1"></a><span class="kw">dgm</span>()</span></code></pre></div>
<pre><code>## Error in stopifnot(pie &gt;= 0, cheesecake &gt;= 0, is.numeric(pie), is.numeric(cookie), : argument "pie" is missing, with no default</code></pre>
<p>Oops! At the moment, this causes a fatal error. It can be nice to provide some reasonable default values for certain arguments. In our case, it would be reasonable to specify default values for <code>mean</code> and <code>sd</code>, because <code>rnorm()</code> already specifies such values as 0 and 1, respectively.</p>
<div class="sourceCode" id="cb552"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb552-1"><a href="functions.html#cb552-1"></a>dgm &lt;-<span class="st"> </span><span class="cf">function</span>(n, <span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">sd =</span> <span class="dv">1</span>) {</span>
<span id="cb552-2"><a href="functions.html#cb552-2"></a>  <span class="kw">stopifnot</span>(n <span class="op">&gt;=</span><span class="st"> </span><span class="dv">0</span>,</span>
<span id="cb552-3"><a href="functions.html#cb552-3"></a>            sd <span class="op">&gt;=</span><span class="st"> </span><span class="dv">0</span>,</span>
<span id="cb552-4"><a href="functions.html#cb552-4"></a>            <span class="kw">is.numeric</span>(n),</span>
<span id="cb552-5"><a href="functions.html#cb552-5"></a>            <span class="kw">is.numeric</span>(mean),</span>
<span id="cb552-6"><a href="functions.html#cb552-6"></a>            <span class="kw">is.numeric</span>(sd))</span>
<span id="cb552-7"><a href="functions.html#cb552-7"></a>  <span class="kw">runif</span>(<span class="dv">1</span>) <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(n, mean, sd)</span>
<span id="cb552-8"><a href="functions.html#cb552-8"></a>}</span></code></pre></div>
<p>Again we check how the function works in a few different permutations of specifying and not specifying certain values.</p>
<div class="sourceCode" id="cb553"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb553-1"><a href="functions.html#cb553-1"></a><span class="kw">dgm</span>(<span class="dt">n =</span> <span class="dv">1</span>)</span></code></pre></div>
<pre><code>## [1] 0.15</code></pre>
<div class="sourceCode" id="cb555"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb555-1"><a href="functions.html#cb555-1"></a><span class="kw">dgm</span>(<span class="dv">1</span>, <span class="dv">10</span>)</span></code></pre></div>
<pre><code>## [1] 9.7</code></pre>
<div class="sourceCode" id="cb557"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb557-1"><a href="functions.html#cb557-1"></a><span class="kw">dgm</span>(<span class="dt">n =</span> <span class="dv">1</span>, <span class="dt">sd =</span> <span class="dv">5</span>)</span></code></pre></div>
<pre><code>## [1] -2.6</code></pre>
<div class="sourceCode" id="cb559"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb559-1"><a href="functions.html#cb559-1"></a><span class="kw">dgm</span>(<span class="dv">4</span>, <span class="dv">10</span>, <span class="dv">5</span>)</span></code></pre></div>
<pre><code>## [1] 4.7 4.7 3.5 7.4</code></pre>
<p>Note that sometimes we specified the argument name and sometimes we didn’t. R tries its best to understand you based on the order you provide your argument values in. However, it is usually best practice to specify the argument name.</p>
</div>
<div id="wrap-up-and-whats-next-1" class="section level3">
<h3>
<span class="header-section-number">4.4.4</span> Wrap-up and what’s next?</h3>
<p>Here’s the function we’ve written so far:</p>
<div class="sourceCode" id="cb561"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb561-1"><a href="functions.html#cb561-1"></a>dgm</span></code></pre></div>
<pre><code>## function(n, mean = 0, sd = 1) {
##   stopifnot(n &gt;= 0,
##             sd &gt;= 0,
##             is.numeric(n),
##             is.numeric(mean),
##             is.numeric(sd))
##   runif(1) + rnorm(n, mean, sd)
## }
## &lt;bytecode: 0x7fa931478520&gt;</code></pre>
<p>What we’ve accomplished:</p>
<ul>
<li>We’ve generalized our data generating function to take in custom values for the <code>n</code>, <code>mean</code>, and <code>sd</code> of the normally distributed random variable.</li>
<li>We’ve specified default values <code>mean = 0</code> and <code>sd = 1</code>.</li>
</ul>
</div>
</div>
<div id="formal-testing" class="section level2">
<h2>
<span class="header-section-number">4.5</span> Formal Testing</h2>
<p>In this section, we tackle <code>NA</code>s, the special argument <code>...</code> and formal testing.</p>
<div id="use-testthat-for-formal-unit-tests" class="section level3">
<h3>
<span class="header-section-number">4.5.1</span> Use testthat for formal unit tests</h3>
<p>Until now, we’ve relied on informal tests such as trying to break our function with silly inputs. If you are going to use a function a lot, especially if it is part of a package, it is wise to use formal unit tests.</p>
<p>The [testthat][testthat-web] package ([CRAN][testthat-cran]; [GitHub][testthat-github]) provides excellent facilities for this, with a distinct emphasis on automated unit testing of entire packages. However, we can take it out for a test drive even with our one measly function.</p>
<p>We will construct a test with <code>test_that()</code> and, within it, we put one or more <em>expectations</em> that check actual against expected results. You simply harden your informal, interactive tests into formal unit tests. Here are some examples of tests and indicative expectations.</p>
<p>Let’s keep our very first function around as a baseline.</p>
<div class="sourceCode" id="cb563"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb563-1"><a href="functions.html#cb563-1"></a>dgm &lt;-<span class="st"> </span><span class="cf">function</span>(n, <span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">sd =</span> <span class="dv">1</span>) {</span>
<span id="cb563-2"><a href="functions.html#cb563-2"></a>  <span class="kw">stopifnot</span>(n <span class="op">&gt;=</span><span class="st"> </span><span class="dv">0</span>,</span>
<span id="cb563-3"><a href="functions.html#cb563-3"></a>            sd <span class="op">&gt;=</span><span class="st"> </span><span class="dv">0</span>,</span>
<span id="cb563-4"><a href="functions.html#cb563-4"></a>            <span class="kw">is.numeric</span>(n),</span>
<span id="cb563-5"><a href="functions.html#cb563-5"></a>            <span class="kw">is.numeric</span>(mean),</span>
<span id="cb563-6"><a href="functions.html#cb563-6"></a>            <span class="kw">is.numeric</span>(sd))</span>
<span id="cb563-7"><a href="functions.html#cb563-7"></a>  <span class="kw">runif</span>(<span class="dv">1</span>) <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(n, mean, sd)</span>
<span id="cb563-8"><a href="functions.html#cb563-8"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb564"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb564-1"><a href="functions.html#cb564-1"></a><span class="kw">library</span>(testthat)</span></code></pre></div>
<pre><code>## 
## Attaching package: 'testthat'</code></pre>
<pre><code>## The following object is masked from 'package:dplyr':
## 
##     matches</code></pre>
<pre><code>## The following object is masked from 'package:purrr':
## 
##     is_null</code></pre>
<pre><code>## The following object is masked from 'package:tidyr':
## 
##     matches</code></pre>
<pre><code>## The following object is masked from 'package:gt':
## 
##     matches</code></pre>
<div class="sourceCode" id="cb570"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb570-1"><a href="functions.html#cb570-1"></a><span class="kw">test_that</span>(<span class="st">'invalid args are detected'</span>, {</span>
<span id="cb570-2"><a href="functions.html#cb570-2"></a>  <span class="kw">expect_error</span>(<span class="kw">dgm</span>(<span class="st">"desserts are great!"</span>, <span class="st">"yum"</span>, <span class="dv">-2</span>))</span>
<span id="cb570-3"><a href="functions.html#cb570-3"></a>  <span class="kw">expect_error</span>(<span class="kw">dgm</span>(kenya))</span>
<span id="cb570-4"><a href="functions.html#cb570-4"></a>})</span></code></pre></div>
<p>No news is good news! Let’s see what test failure would look like. Let’s revert to a version of our function that does not check for a positive <code>sd</code> value and test it. We can watch it fail.</p>
<div class="sourceCode" id="cb571"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb571-1"><a href="functions.html#cb571-1"></a>dgm &lt;-<span class="st"> </span><span class="cf">function</span>(n, <span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">sd =</span> <span class="dv">1</span>) {</span>
<span id="cb571-2"><a href="functions.html#cb571-2"></a>  <span class="kw">stopifnot</span>(n <span class="op">&gt;=</span><span class="st"> </span><span class="dv">0</span>,</span>
<span id="cb571-3"><a href="functions.html#cb571-3"></a>            <span class="kw">is.numeric</span>(n),</span>
<span id="cb571-4"><a href="functions.html#cb571-4"></a>            <span class="kw">is.numeric</span>(mean),</span>
<span id="cb571-5"><a href="functions.html#cb571-5"></a>            <span class="kw">is.numeric</span>(sd))</span>
<span id="cb571-6"><a href="functions.html#cb571-6"></a>  <span class="kw">runif</span>(<span class="dv">1</span>) <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(n, mean, sd)</span>
<span id="cb571-7"><a href="functions.html#cb571-7"></a>}</span>
<span id="cb571-8"><a href="functions.html#cb571-8"></a></span>
<span id="cb571-9"><a href="functions.html#cb571-9"></a><span class="kw">show_failure</span>(<span class="kw">dgm</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">-2</span>))</span></code></pre></div>
<pre><code>## Warning in rnorm(n, mean, sd): NAs produced</code></pre>
<p>Similar to the advice to use assertions in data analytical scripts, I recommend you use unit tests to monitor the behavior of functions you (or others) will use often. If your tests cover the function’s important behavior, then you can edit the internals freely. You’ll rest easy in the knowledge that, if you broke anything important, the tests will fail and alert you to the problem. A function that is important enough for unit tests probably also belongs in a package, where there are obvious mechanisms for running the tests as part of overall package checks.</p>
</div>
<div id="what-a-function-returns" class="section level3">
<h3>
<span class="header-section-number">4.5.2</span> What a function returns</h3>
<p>By default, a function returns the result of the last line of the body. We are just letting that happen with the line <code>runif(1) + rnorm(n, mean, sd)</code>. However, there is an explicit function for this: <code>return()</code>. We could just as easily make this the last line of my function’s body:</p>
<div class="sourceCode" id="cb573"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb573-1"><a href="functions.html#cb573-1"></a><span class="kw">return</span>(<span class="kw">runif</span>(<span class="dv">1</span>) <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(n, mean, sd))</span></code></pre></div>
<p>You absolutely must use <code>return()</code> if you want to return early based on some condition, i.e. before execution gets to the last line of the body. Otherwise, you can decide your own conventions about when you use <code>return()</code> and when you don’t.</p>
<p>Right now, running <code>dgm(5)</code> gives us a vector of five numbers. What if we want the output to be a list with a single column named <code>runs</code>?</p>
<div class="sourceCode" id="cb574"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb574-1"><a href="functions.html#cb574-1"></a>dgm &lt;-<span class="st"> </span><span class="cf">function</span>(n, <span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">sd =</span> <span class="dv">1</span>) {</span>
<span id="cb574-2"><a href="functions.html#cb574-2"></a>  <span class="kw">stopifnot</span>(n <span class="op">&gt;=</span><span class="st"> </span><span class="dv">0</span>,</span>
<span id="cb574-3"><a href="functions.html#cb574-3"></a>            sd <span class="op">&gt;=</span><span class="st"> </span><span class="dv">0</span>,</span>
<span id="cb574-4"><a href="functions.html#cb574-4"></a>            <span class="kw">is.numeric</span>(n),</span>
<span id="cb574-5"><a href="functions.html#cb574-5"></a>            <span class="kw">is.numeric</span>(mean),</span>
<span id="cb574-6"><a href="functions.html#cb574-6"></a>            <span class="kw">is.numeric</span>(sd))</span>
<span id="cb574-7"><a href="functions.html#cb574-7"></a>  <span class="kw">return</span>(<span class="kw">list</span>(<span class="kw">runif</span>(<span class="dv">1</span>) <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(n, mean, sd)))</span>
<span id="cb574-8"><a href="functions.html#cb574-8"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb575"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb575-1"><a href="functions.html#cb575-1"></a><span class="kw">dgm</span>(<span class="dv">5</span>)</span></code></pre></div>
<pre><code>## [[1]]
## [1]  2.49  1.65 -1.66 -1.33 -0.17</code></pre>
<p>Now, we have a data generating function that can take in values <code>n</code>, <code>mean</code>, and <code>sd</code>, returning a list of random variables. How would this be useful in the real world?</p>
<p>Say you are playing an arcade game that grants you a random amount of tickets. The total payout of the game is the sum of a uniformly distributed random variable and a normally distributed random variable. The normally distributed random variable has an average payout of 25 tickets and a standard deviation of 5 tickets. The uniformly distributed random variable adds in extra randomness between 0-1 additional tickets, with an even chance of getting any number of tickets.</p>
<p>Say you play the game twice. What could be the possible number of tickets you win from each play?</p>
<div class="sourceCode" id="cb577"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb577-1"><a href="functions.html#cb577-1"></a><span class="kw">dgm</span>(<span class="dv">2</span>, <span class="dv">25</span>, <span class="dv">5</span>)</span></code></pre></div>
<pre><code>## [[1]]
## [1] 32 22</code></pre>
<p>Sweet! Just to make our function truly fit this example, let’s make <code>dgm()</code> round the total number of tickets to the nearest integer. After all, you can’t cash out 12.5 tickets for a plushie!</p>
<div class="sourceCode" id="cb579"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb579-1"><a href="functions.html#cb579-1"></a>dgm &lt;-<span class="st"> </span><span class="cf">function</span>(n, <span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">sd =</span> <span class="dv">1</span>) {</span>
<span id="cb579-2"><a href="functions.html#cb579-2"></a>  <span class="kw">stopifnot</span>(n <span class="op">&gt;=</span><span class="st"> </span><span class="dv">0</span>,</span>
<span id="cb579-3"><a href="functions.html#cb579-3"></a>            sd <span class="op">&gt;=</span><span class="st"> </span><span class="dv">0</span>,</span>
<span id="cb579-4"><a href="functions.html#cb579-4"></a>            <span class="kw">is.numeric</span>(n),</span>
<span id="cb579-5"><a href="functions.html#cb579-5"></a>            <span class="kw">is.numeric</span>(mean),</span>
<span id="cb579-6"><a href="functions.html#cb579-6"></a>            <span class="kw">is.numeric</span>(sd))</span>
<span id="cb579-7"><a href="functions.html#cb579-7"></a>  <span class="kw">return</span>(<span class="kw">list</span>(<span class="kw">round</span>(<span class="kw">runif</span>(<span class="dv">1</span>) <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(n, mean, sd))))</span>
<span id="cb579-8"><a href="functions.html#cb579-8"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb580"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb580-1"><a href="functions.html#cb580-1"></a><span class="kw">dgm</span>(<span class="dv">2</span>, <span class="dv">25</span>, <span class="dv">5</span>)</span></code></pre></div>
<pre><code>## [[1]]
## [1] 23 29</code></pre>
<p>Now you have created your very first data generating mechanism that models a real-world phenomena. This theme will come up more and more as you journey onwards.</p>
</div>
<div id="handling-nas" class="section level3">
<h3>
<span class="header-section-number">4.5.3</span> Handling <code>NA</code>s</h3>
<p>The upside to creating our own data generating function is that there have been no missing values. In real life, missing data will make your life a living hell. If you are lucky, it will be properly indicated by the special value <code>NA</code>, but don’t hold your breath. Many built-in R functions have an <code>na.rm =</code> argument through which you can specify how you want to handle <code>NA</code>s. Typically the default value is <code>na.rm = FALSE</code> and typical default behavior is to either let <code>NA</code>s propagate or to raise an error. Let’s see how <code>quantile()</code> handles <code>NA</code>s:</p>
<div class="sourceCode" id="cb582"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb582-1"><a href="functions.html#cb582-1"></a>z &lt;-<span class="st"> </span>kenya<span class="op">$</span>poverty</span>
<span id="cb582-2"><a href="functions.html#cb582-2"></a>z[<span class="dv">3</span>] &lt;-<span class="st"> </span><span class="ot">NA</span></span>
<span id="cb582-3"><a href="functions.html#cb582-3"></a><span class="kw">quantile</span>(kenya<span class="op">$</span>poverty)</span></code></pre></div>
<pre><code>##   0%  25%  50%  75% 100% 
## 0.18 0.35 0.43 0.49 0.90</code></pre>
<div class="sourceCode" id="cb584"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb584-1"><a href="functions.html#cb584-1"></a><span class="kw">quantile</span>(z)</span></code></pre></div>
<pre><code>## Error in quantile.default(z): missing values and NaN's not allowed if 'na.rm' is FALSE</code></pre>
<div class="sourceCode" id="cb586"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb586-1"><a href="functions.html#cb586-1"></a><span class="kw">quantile</span>(z, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<pre><code>##   0%  25%  50%  75% 100% 
## 0.18 0.35 0.43 0.49 0.90</code></pre>
<p>So <code>quantile()</code> simply will not operate in the presence of <code>NA</code>s unless <code>na.rm = TRUE</code>. How shall we modify our function?</p>
<p>If we wanted to hardwire <code>na.rm = TRUE</code>, we could. Focus on our call to <code>quantile()</code> inside our definition of a new function, <code>quantile_diff()</code>.</p>
<div class="sourceCode" id="cb588"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb588-1"><a href="functions.html#cb588-1"></a>quantile_diff &lt;-<span class="st"> </span><span class="cf">function</span>(x, <span class="dt">probs =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) {</span>
<span id="cb588-2"><a href="functions.html#cb588-2"></a>  <span class="kw">stopifnot</span>(<span class="kw">is.numeric</span>(x))</span>
<span id="cb588-3"><a href="functions.html#cb588-3"></a>  the_quantiles &lt;-<span class="st"> </span><span class="kw">quantile</span>(x, probs, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</span>
<span id="cb588-4"><a href="functions.html#cb588-4"></a>  <span class="kw">max</span>(the_quantiles) <span class="op">-</span><span class="st"> </span><span class="kw">min</span>(the_quantiles)</span>
<span id="cb588-5"><a href="functions.html#cb588-5"></a>}</span>
<span id="cb588-6"><a href="functions.html#cb588-6"></a><span class="kw">quantile_diff</span>(kenya<span class="op">$</span>poverty)</span></code></pre></div>
<pre><code>## [1] 0.72</code></pre>
<div class="sourceCode" id="cb590"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb590-1"><a href="functions.html#cb590-1"></a><span class="kw">quantile_diff</span>(z)</span></code></pre></div>
<pre><code>## [1] 0.72</code></pre>
<p>This works but it is dangerous to invert the default behavior of a well-known built-in function and to provide the user with no way to override this.</p>
<p>We could add an <code>na.rm =</code> argument to our own function. We might even enforce our preferred default – but at least we’re giving the user a way to control the behavior around <code>NA</code>s.</p>
<div class="sourceCode" id="cb592"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb592-1"><a href="functions.html#cb592-1"></a>quantile_diff &lt;-<span class="st"> </span><span class="cf">function</span>(x, <span class="dt">probs =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) {</span>
<span id="cb592-2"><a href="functions.html#cb592-2"></a>  <span class="kw">stopifnot</span>(<span class="kw">is.numeric</span>(x))</span>
<span id="cb592-3"><a href="functions.html#cb592-3"></a>  the_quantiles &lt;-<span class="st"> </span><span class="kw">quantile</span>(x, probs, <span class="dt">na.rm =</span> na.rm)</span>
<span id="cb592-4"><a href="functions.html#cb592-4"></a>  <span class="kw">max</span>(the_quantiles) <span class="op">-</span><span class="st"> </span><span class="kw">min</span>(the_quantiles)</span>
<span id="cb592-5"><a href="functions.html#cb592-5"></a>}</span>
<span id="cb592-6"><a href="functions.html#cb592-6"></a><span class="kw">quantile_diff</span>(kenya<span class="op">$</span>poverty)</span></code></pre></div>
<pre><code>## [1] 0.72</code></pre>
<div class="sourceCode" id="cb594"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb594-1"><a href="functions.html#cb594-1"></a><span class="kw">quantile_diff</span>(z)</span></code></pre></div>
<pre><code>## [1] 0.72</code></pre>
<div class="sourceCode" id="cb596"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb596-1"><a href="functions.html#cb596-1"></a><span class="kw">quantile_diff</span>(z, <span class="dt">na.rm =</span> <span class="ot">FALSE</span>)</span></code></pre></div>
<pre><code>## Error in quantile.default(x, probs, na.rm = na.rm): missing values and NaN's not allowed if 'na.rm' is FALSE</code></pre>
</div>
<div id="the-useful-but-mysterious-...-argument" class="section level3">
<h3>
<span class="header-section-number">4.5.4</span> The useful but mysterious <code>...</code> argument</h3>
<p>You probably could have lived a long and happy life without knowing there are at least 9 different algorithms for computing quantiles. [Go read about the <code>type</code> argument][rdocs-quantile] of <code>quantile()</code>. TLDR: If a quantile is not unambiguously equal to an observed data point, you must somehow average two data points. You can weight this average different ways, depending on the rest of the data, and <code>type =</code> controls this.</p>
<p>Let’s say we want to give the user of our function the ability to specify how the quantiles are computed, but we want to accomplish with as little fuss as possible. In fact, we don’t even want to clutter our function’s interface with this! This calls for the very special <code>...</code> argument. In English, this set of three dots is frequently called an “ellipsis”.</p>
<div class="sourceCode" id="cb598"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb598-1"><a href="functions.html#cb598-1"></a>quantile_diff &lt;-<span class="st"> </span><span class="cf">function</span>(x, <span class="dt">probs =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">na.rm =</span> <span class="ot">TRUE</span>, ...) {</span>
<span id="cb598-2"><a href="functions.html#cb598-2"></a>  the_quantiles &lt;-<span class="st"> </span><span class="kw">quantile</span>(<span class="dt">x =</span> x, <span class="dt">probs =</span> probs, <span class="dt">na.rm =</span> na.rm, ...)</span>
<span id="cb598-3"><a href="functions.html#cb598-3"></a>  <span class="kw">max</span>(the_quantiles) <span class="op">-</span><span class="st"> </span><span class="kw">min</span>(the_quantiles)</span>
<span id="cb598-4"><a href="functions.html#cb598-4"></a>}</span></code></pre></div>
<p>Thanks to [@wrathematics][twitter-wrathematics], here’s a small example where we can (barely) detect a difference due to <code>type</code>.</p>
<div class="sourceCode" id="cb599"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb599-1"><a href="functions.html#cb599-1"></a><span class="kw">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb599-2"><a href="functions.html#cb599-2"></a>z &lt;-<span class="st"> </span><span class="kw">rnorm</span>(<span class="dv">10</span>)</span>
<span id="cb599-3"><a href="functions.html#cb599-3"></a><span class="kw">quantile</span>(z, <span class="dt">type =</span> <span class="dv">1</span>)</span></code></pre></div>
<pre><code>##    0%   25%   50%   75%  100% 
## -2.35 -0.89 -0.56  0.43  1.08</code></pre>
<div class="sourceCode" id="cb601"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb601-1"><a href="functions.html#cb601-1"></a><span class="kw">quantile</span>(z, <span class="dt">type =</span> <span class="dv">4</span>)</span></code></pre></div>
<pre><code>##    0%   25%   50%   75%  100% 
## -2.35 -1.05 -0.56  0.35  1.08</code></pre>
<div class="sourceCode" id="cb603"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb603-1"><a href="functions.html#cb603-1"></a><span class="kw">all.equal</span>(<span class="kw">quantile</span>(z, <span class="dt">type =</span> <span class="dv">1</span>), <span class="kw">quantile</span>(z, <span class="dt">type =</span> <span class="dv">4</span>))</span></code></pre></div>
<pre><code>## [1] "Mean relative difference: 0.18"</code></pre>
<p>Now we can call our function, requesting that quantiles be computed in different ways.</p>
<div class="sourceCode" id="cb605"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb605-1"><a href="functions.html#cb605-1"></a><span class="kw">quantile_diff</span>(z, <span class="dt">probs =</span> <span class="kw">c</span>(<span class="fl">0.25</span>, <span class="fl">0.75</span>), <span class="dt">type =</span> <span class="dv">1</span>)</span></code></pre></div>
<pre><code>## [1] 1.3</code></pre>
<div class="sourceCode" id="cb607"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb607-1"><a href="functions.html#cb607-1"></a><span class="kw">quantile_diff</span>(z, <span class="dt">probs =</span> <span class="kw">c</span>(<span class="fl">0.25</span>, <span class="fl">0.75</span>), <span class="dt">type =</span> <span class="dv">4</span>)</span></code></pre></div>
<pre><code>## [1] 1.4</code></pre>
<p>While the difference may be subtle, <strong>it’s there</strong>. Marvel at the fact that we have passed <code>type = 1</code> through to <code>quantile()</code> <em>even though it was not a formal argument of our own function</em>.</p>
<p>The special argument <code>...</code> is very useful when you want the ability to pass arbitrary arguments down to another function, but without constantly expanding the formal arguments to your function. This leaves you with a less cluttered function definition and gives you future flexibility to specify these arguments only when you need to. This is why the <code>...</code> argument is used in conjunction with <code>map_*</code> functions.</p>
<p>There are also downsides to <code>...</code>, so use it with intention. In a package, you will have to work harder to create truly informative documentation for your user. Also, the quiet, absorbent properties of <code>...</code> mean it can sometimes silently swallow other named arguments, when the user has a typo in the name. Depending on whether or how this fails, it can be a little tricky to find out what went wrong.</p>
<p>The <a href="https://ellipsis.r-lib.org">ellipsis package</a> provides tools that help package developers use <code>...</code> more safely. The in-progress tidyverse principles guide provides further guidance on the design of functions that take <code>...</code> in <a href="https://principles.tidyverse.org/dots-position.html">Data, dots, details</a>.</p>
</div>
</div>
<div id="list-columns-and-map_-functions-with-custom-and-anonymous-functions" class="section level2">
<h2>
<span class="header-section-number">4.6</span> List-columns and <code>map_*</code> functions with custom and anonymous functions</h2>
<div id="using-map_-functions-with-anonymous-functions" class="section level3">
<h3>
<span class="header-section-number">4.6.1</span> Using <code>map_*</code> functions with anonymous functions</h3>
<p>We can create functions that do operations “on the fly” without bothering to give them a name. These nameless functions are called <a href="https://coolbutuseless.github.io/2019/03/13/anonymous-functions-in-r-part-1/">anonymous functions.</a>
There are two ways to create anonymous functions. The first one, using base R, uses <code>function()</code> to create a function within <code>map_dbl()</code>.</p>
<div class="sourceCode" id="cb609"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb609-1"><a href="functions.html#cb609-1"></a><span class="kw">tibble</span>(<span class="dt">start =</span> <span class="kw">c</span>(<span class="dv">3</span>, <span class="fl">2.5</span>, <span class="dv">6</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb609-2"><a href="functions.html#cb609-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">new =</span> <span class="kw">map_dbl</span>(start, <span class="cf">function</span>(x) x <span class="op">+</span><span class="st"> </span><span class="dv">1</span>))</span></code></pre></div>
<pre><code>## # A tibble: 3 x 2
##   start   new
##   &lt;dbl&gt; &lt;dbl&gt;
## 1   3     4  
## 2   2.5   3.5
## 3   6     7</code></pre>
<p>The second, using the <strong>purrr</strong> package (from where we get <code>map_dbl()</code>), starts with the <code>~</code> operator and then uses <code>.</code> to represent the current element.</p>
<div class="sourceCode" id="cb611"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb611-1"><a href="functions.html#cb611-1"></a><span class="kw">tibble</span>(<span class="dt">start =</span> <span class="kw">c</span>(<span class="dv">3</span>, <span class="fl">2.5</span>, <span class="dv">6</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb611-2"><a href="functions.html#cb611-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">new =</span> <span class="kw">map_dbl</span>(start, <span class="op">~</span><span class="st"> </span>(. <span class="op">+</span><span class="st"> </span><span class="dv">1</span>)))</span></code></pre></div>
<pre><code>## # A tibble: 3 x 2
##   start   new
##   &lt;dbl&gt; &lt;dbl&gt;
## 1   3     4  
## 2   2.5   3.5
## 3   6     7</code></pre>
<p>Note that the parantheses are not necessary. As long as everything after the <code>~</code> works as R code, the anonymous function should work, each time replace the <code>.</code> with the value of the <code>.x</code> variable — which is <code>start</code> in this case — with its value in that row.</p>
<div class="sourceCode" id="cb613"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb613-1"><a href="functions.html#cb613-1"></a><span class="kw">tibble</span>(<span class="dt">start =</span> <span class="kw">c</span>(<span class="dv">3</span>, <span class="fl">2.5</span>, <span class="dv">6</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb613-2"><a href="functions.html#cb613-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">new =</span> <span class="kw">map_dbl</span>(start, <span class="op">~</span><span class="st"> </span>. <span class="op">+</span><span class="st"> </span><span class="dv">1</span>))</span></code></pre></div>
<pre><code>## # A tibble: 3 x 2
##   start   new
##   &lt;dbl&gt; &lt;dbl&gt;
## 1   3     4  
## 2   2.5   3.5
## 3   6     7</code></pre>
<p>The <code>~</code> shorthand is very convenient once you get used to it. Let’s see it in an example. We’ll use the <code>weather</code> dataset in the <code>nycflights13</code> package. Let’s say that we want to return a list-column with all the recorded temperatures in a day in Celsius.</p>
<p>First, let’s wrangle the data so each observation is a day rather than an hour. We’ll create a list column <code>temps_F</code> that consists of all the temperatures recorded that day at a particular origin.</p>
<div class="sourceCode" id="cb615"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb615-1"><a href="functions.html#cb615-1"></a>weather <span class="op">%&gt;%</span></span>
<span id="cb615-2"><a href="functions.html#cb615-2"></a><span class="st">  </span><span class="kw">group_by</span>(origin, year, month, day) <span class="op">%&gt;%</span></span>
<span id="cb615-3"><a href="functions.html#cb615-3"></a><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">temps_F =</span> <span class="kw">list</span>(<span class="kw">c</span>(temp)))</span></code></pre></div>
<p>Now that we have a list column, we can use it as the input to <code>map()</code>, outputting another list column. Let’s say we wanted a new list column, <code>temps_C</code>, which records the temperature in Celsius:</p>
<div class="sourceCode" id="cb616"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb616-1"><a href="functions.html#cb616-1"></a>weather <span class="op">%&gt;%</span></span>
<span id="cb616-2"><a href="functions.html#cb616-2"></a><span class="st">  </span><span class="kw">group_by</span>(origin, year, month, day) <span class="op">%&gt;%</span></span>
<span id="cb616-3"><a href="functions.html#cb616-3"></a><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">temps_F =</span> <span class="kw">list</span>(<span class="kw">c</span>(temp))) <span class="op">%&gt;%</span></span>
<span id="cb616-4"><a href="functions.html#cb616-4"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">temps_C =</span> <span class="kw">map</span>(temps_F, <span class="op">~</span><span class="st"> </span>(. <span class="op">-</span><span class="st"> </span><span class="dv">32</span>) <span class="op">*</span><span class="st"> </span><span class="dv">5</span><span class="op">/</span><span class="dv">9</span>))</span></code></pre></div>
</div>
<div id="using-map_-functions-with-custom-functions" class="section level3">
<h3>
<span class="header-section-number">4.6.2</span> Using <code>map_*</code> functions with custom functions</h3>
<p>Let’s practice <code>map_*</code> functions and list columns! We will give step by step instructions; we recommend that you follow along so that you understand how each part works. We will introduce writing anonymous functions in this section. We’ll also be introducing some important conditional functions (<code>ifelse()</code>, <code>any()</code>, <code>all()</code>, and <code>case_when()</code>).</p>
<ol style="list-style-type: lower-alpha">
<li>Write a function called <code>roll_dice()</code>, which will throw a pair of dice as many times as the user specifies.</li>
</ol>
<!-- EC: Added a few more intermediate steps in creating roll_dice() --><p>We will begin by creating a minimally viable function, <code>starter_dice()</code>, which throws one die one time.</p>
<div class="sourceCode" id="cb617"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb617-1"><a href="functions.html#cb617-1"></a>starter_dice &lt;-<span class="st"> </span><span class="cf">function</span>() <span class="kw">sample</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">6</span>, <span class="dv">1</span>)</span></code></pre></div>
<p>From here, we can add a formal argument <code>n</code>, which requires the number of dice to be specified. Let’s set the default value of <code>n</code> to 1. However, if more than one dice is thrown, we want to make sure that any number from <code>1-6</code> has the chance of being returned. To do so, make sure the <code>replace</code> argument in <code>sample()</code> is set to <code>TRUE</code>. Now we have generalized the function <code>starter_dice()</code>!</p>
<div class="sourceCode" id="cb618"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb618-1"><a href="functions.html#cb618-1"></a>starter_dice &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">n =</span> <span class="dv">1</span>) <span class="kw">sample</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">6</span>, n, <span class="dt">replace =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<p>Now let’s create an intermediate function <code>add_dice()</code> which throws n dice and adds the results:</p>
<div class="sourceCode" id="cb619"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb619-1"><a href="functions.html#cb619-1"></a>add_dice &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">n =</span> <span class="dv">1</span>) {</span>
<span id="cb619-2"><a href="functions.html#cb619-2"></a>  <span class="kw">stopifnot</span>(<span class="kw">is.numeric</span>(n))</span>
<span id="cb619-3"><a href="functions.html#cb619-3"></a>  <span class="kw">sum</span>(<span class="kw">sample</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">6</span>, n, <span class="dt">replace =</span> <span class="ot">TRUE</span>))</span>
<span id="cb619-4"><a href="functions.html#cb619-4"></a>}</span></code></pre></div>
<p>Next, we will create <code>roll_dice()</code>, which calls <code>add_dice(n = 2)</code> as many times as the user specifies:</p>
<div class="sourceCode" id="cb620"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb620-1"><a href="functions.html#cb620-1"></a>roll_dice &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">n =</span> <span class="dv">1</span>) {</span>
<span id="cb620-2"><a href="functions.html#cb620-2"></a>  <span class="kw">stopifnot</span>(<span class="kw">is.numeric</span>(n))</span>
<span id="cb620-3"><a href="functions.html#cb620-3"></a>  <span class="kw">map_int</span>(<span class="kw">rep</span>(<span class="dv">2</span>, n), add_dice)</span>
<span id="cb620-4"><a href="functions.html#cb620-4"></a>}</span></code></pre></div>
<p><code>rep()</code> is a useful input to <code>map_*</code> when you want to call a function with the same input multiple times. <code>rep(2, n)</code> creates a vector of length n where every element is 2. We use that as the input to <code>map_int()</code> because we want the input to <code>add_dice()</code> to be 2 every time (we are always throwing a pair of dice) and we want to perform the operation n times, chosen by the user.</p>
<ol start="2" style="list-style-type: lower-alpha">
<li>Create a tibble named <code>x</code> with one variable: <code>throws</code>. <code>throws</code> is a list column, each element of which is three throws of the dice pair, i.e., the result of calling <code>roll_dice(n = 3)</code>. Thus, our tibble will have ten rows and two columns.</li>
</ol>
<div class="sourceCode" id="cb621"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb621-1"><a href="functions.html#cb621-1"></a>x &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">throws =</span> <span class="kw">map</span>(<span class="kw">rep</span>(<span class="dv">3</span>, <span class="dv">10</span>), roll_dice))</span></code></pre></div>
<ol start="3" style="list-style-type: lower-alpha">
<li>Add a variable to <code>x</code> called <code>first_seven</code> which is TRUE if the first roll in <code>throws</code> is a 7.</li>
</ol>
<div class="sourceCode" id="cb622"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb622-1"><a href="functions.html#cb622-1"></a><span class="kw">library</span>(magrittr)</span>
<span id="cb622-2"><a href="functions.html#cb622-2"></a></span>
<span id="cb622-3"><a href="functions.html#cb622-3"></a><span class="co"># The magrittr package allows us to use %&lt;&gt;%, the compound assignment pipe</span></span>
<span id="cb622-4"><a href="functions.html#cb622-4"></a><span class="co"># operator, which (as its name suggests) both assigns and pipes</span></span>
<span id="cb622-5"><a href="functions.html#cb622-5"></a></span>
<span id="cb622-6"><a href="functions.html#cb622-6"></a>x <span class="op">%&lt;&gt;%</span><span class="st"> </span></span>
<span id="cb622-7"><a href="functions.html#cb622-7"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">first_seven =</span> <span class="kw">map_lgl</span>(throws, <span class="op">~</span><span class="st"> </span><span class="kw">ifelse</span>(.[[<span class="dv">1</span>]] <span class="op">==</span><span class="st"> </span><span class="dv">7</span>, <span class="ot">TRUE</span>, <span class="ot">FALSE</span>)))</span></code></pre></div>
<p>We see here that <code>[[1]]</code> is how we extract the first element of a list, just like <code>[1]</code> extracts the first element of an atomic vector. <code>ifelse()</code> takes as its first argument a condition; if it is TRUE it returns the second argument (here TRUE) and if not the third (here FALSE).</p>
<ol start="4" style="list-style-type: lower-alpha">
<li>Add a variable to <code>x</code> called <code>a_winner</code> which is TRUE if at least one of the three throws is a 7 or an 11 and is FALSE otherwise.</li>
</ol>
<div class="sourceCode" id="cb623"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb623-1"><a href="functions.html#cb623-1"></a>x <span class="op">%&lt;&gt;%</span><span class="st"> </span></span>
<span id="cb623-2"><a href="functions.html#cb623-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">a_winner =</span> <span class="kw">map_lgl</span>(throws, <span class="op">~</span><span class="st"> </span><span class="kw">ifelse</span>(<span class="kw">any</span>(<span class="kw">c</span>(<span class="dv">7</span>, <span class="dv">11</span>) <span class="op">%in%</span><span class="st"> </span>.), <span class="ot">TRUE</span>, <span class="ot">FALSE</span>)))</span></code></pre></div>
<p>Here we use <code>any()</code>: <code>any()</code> checks if any element in its input is TRUE. So, let’s say a particular throw was 4, 6, and 7: <code>c(7, 11) %in% c(4, 6, 7)</code> returns the vector <code>TRUE FALSE</code> (since 7 is in the vector but 11 isn’t); then, <code>any(c(7, 11) %in% c(4, 6, 7))</code> returns TRUE because one of the conditions is TRUE.</p>
<ol start="5" style="list-style-type: lower-alpha">
<li>Run <code>str()</code> on <code>x</code> and show the results.</li>
</ol>
<div class="sourceCode" id="cb624"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb624-1"><a href="functions.html#cb624-1"></a><span class="kw">str</span>(x)</span></code></pre></div>
<pre><code>## tibble [10 × 3] (S3: tbl_df/tbl/data.frame)
##  $ throws     :List of 10
##   ..$ : int [1:3] 12 10 9
##   ..$ : int [1:3] 7 9 7
##   ..$ : int [1:3] 8 7 7
##   ..$ : int [1:3] 4 10 5
##   ..$ : int [1:3] 7 7 9
##   ..$ : int [1:3] 7 6 3
##   ..$ : int [1:3] 4 8 4
##   ..$ : int [1:3] 9 3 11
##   ..$ : int [1:3] 4 5 7
##   ..$ : int [1:3] 10 5 8
##  $ first_seven: logi [1:10] FALSE TRUE FALSE FALSE TRUE TRUE ...
##  $ a_winner   : logi [1:10] FALSE TRUE TRUE FALSE TRUE TRUE ...</code></pre>
<ol start="6" style="list-style-type: lower-alpha">
<li>Calculate how “surpised” you should be if someone rolls three winners in a row. First, create a tibble with 10,000 rows. Include a <code>throws</code> list column with three throws of our dice, just as in part a). Second, create a column called <code>perfection</code> which is TRUE if all three of the throws are either 7 or 11.</li>
</ol>
<div class="sourceCode" id="cb626"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb626-1"><a href="functions.html#cb626-1"></a>surprised &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">throws =</span> <span class="kw">map</span>(<span class="kw">rep</span>(<span class="dv">3</span>, <span class="dv">10000</span>), roll_dice)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb626-2"><a href="functions.html#cb626-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">perfection =</span> <span class="kw">map_lgl</span>(throws, <span class="op">~</span><span class="st"> </span><span class="kw">ifelse</span>(<span class="kw">all</span>(. <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="dv">7</span>, <span class="dv">11</span>)), <span class="ot">TRUE</span>, <span class="ot">FALSE</span>)))</span>
<span id="cb626-3"><a href="functions.html#cb626-3"></a></span>
<span id="cb626-4"><a href="functions.html#cb626-4"></a>surprised <span class="op">%&gt;%</span></span>
<span id="cb626-5"><a href="functions.html#cb626-5"></a><span class="st">  </span><span class="kw">pull</span>(perfection) <span class="op">%&gt;%</span></span>
<span id="cb626-6"><a href="functions.html#cb626-6"></a><span class="st">  </span><span class="kw">mean</span>()</span></code></pre></div>
<pre><code>## [1] 0.011</code></pre>
<p>Here, we use <code>all()</code>, which has the same structure as <code>any()</code>, but checks whether <em>all</em> the elements in the input are TRUE.</p>
<p>Approximately 1.1% of three rolls of a pair of fair dice are all equal to either 7 or 11.</p>
<ol start="7" style="list-style-type: lower-alpha">
<li>Your friend proposes the following bet. You will roll a pair of fair dice 10 times. Side A gets the second highest of the first 4 rolls. Side B gets 1 plus the the median of the remaining 6 rolls. Which side is more likely to win? What’s the chance of a tie?</li>
</ol>
<div class="sourceCode" id="cb628"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb628-1"><a href="functions.html#cb628-1"></a>bet &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">throws =</span> <span class="kw">map</span>(<span class="kw">rep</span>(<span class="dv">10</span>, <span class="dv">10000</span>), roll_dice)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb628-2"><a href="functions.html#cb628-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">A =</span> <span class="kw">map_dbl</span>(throws, <span class="op">~</span><span class="st"> </span><span class="kw">sort</span>(.[<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>])[<span class="dv">3</span>]),</span>
<span id="cb628-3"><a href="functions.html#cb628-3"></a>         <span class="dt">B =</span> <span class="kw">map_dbl</span>(throws, <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw">median</span>(.[<span class="dv">5</span><span class="op">:</span><span class="dv">10</span>])),</span>
<span id="cb628-4"><a href="functions.html#cb628-4"></a>         <span class="dt">winner =</span> <span class="kw">case_when</span>(A <span class="op">&gt;</span><span class="st"> </span>B <span class="op">~</span><span class="st"> "A"</span>,</span>
<span id="cb628-5"><a href="functions.html#cb628-5"></a>                            B <span class="op">&gt;</span><span class="st"> </span>A <span class="op">~</span><span class="st"> "B"</span>,</span>
<span id="cb628-6"><a href="functions.html#cb628-6"></a>                            <span class="ot">TRUE</span> <span class="op">~</span><span class="st"> "tie"</span>))</span>
<span id="cb628-7"><a href="functions.html#cb628-7"></a></span>
<span id="cb628-8"><a href="functions.html#cb628-8"></a><span class="kw">case_when</span>(<span class="kw">sum</span>(bet<span class="op">$</span>winner <span class="op">==</span><span class="st"> "A"</span>) <span class="op">&gt;</span><span class="st"> </span><span class="kw">sum</span>(bet<span class="op">$</span>winner <span class="op">==</span><span class="st"> "B"</span>) <span class="op">~</span><span class="st"> "A"</span>,</span>
<span id="cb628-9"><a href="functions.html#cb628-9"></a>          <span class="kw">sum</span>(bet<span class="op">$</span>winner <span class="op">==</span><span class="st"> "B"</span>) <span class="op">&gt;</span><span class="st"> </span><span class="kw">sum</span>(bet<span class="op">$</span>winner <span class="op">==</span><span class="st"> "A"</span>) <span class="op">~</span><span class="st"> "B"</span>,</span>
<span id="cb628-10"><a href="functions.html#cb628-10"></a>          <span class="ot">TRUE</span> <span class="op">~</span><span class="st"> "Same # Victories"</span>)</span></code></pre></div>
<pre><code>## [1] "B"</code></pre>
<div class="sourceCode" id="cb630"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb630-1"><a href="functions.html#cb630-1"></a><span class="kw">sum</span>(bet<span class="op">$</span>winner <span class="op">==</span><span class="st"> "tie"</span>)<span class="op">/</span><span class="kw">length</span>(bet<span class="op">$</span>winner)</span></code></pre></div>
<pre><code>## [1] 0.11</code></pre>
<p>You can think of <code>case_when()</code> as a generalized <code>ifelse()</code>. The syntax is a little more complicated. Each expression is followed by <code>~</code> and what should be returned if that expression is TRUE. The final expression, TRUE, is always true, and thus is the residual category if none of the above expression are TRUE. Thus, the second <code>case_when()</code> in our above code will print “A” if A is the winner in more replications than B, “B” if B is the winner more than A, and “Same # Victories” otherwise.</p>
<p>Side B is more likely to win.</p>
<p>The chance of a tie is approximately 11%.</p>

</div>
</div>
</div></body></html>

<p style="text-align: center;">
<a href="rubin-causal-model.html"><button class="btn btn-default">Previous</button></a>
<a href="probability.html"><button class="btn btn-default">Next</button></a>
</p>
<p class="build-date">Page built: 
2020-07-27
</p>
</div>
</div>



</body>
</html>
